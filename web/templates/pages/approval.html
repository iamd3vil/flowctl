{{ define "approval" }}
{{ template "partials/header" . }}

<div class="flex flex-col items-center min-h-screen bg-gray-900 py-8"
     x-data="approvalComponent('{{ .Request.ID }}')">
    <p class="font-bold text-5xl mb-2 text-white">Approval Request</p>
    <p class="text-xl text-gray-300 mb-6">{{ .Request.Title }}</p>

    <div class="bg-gray-800 p-8 rounded-lg shadow-lg max-w-screen-md w-full mx-auto mb-8 border border-gray-700">
        <h3 class="font-semibold mb-2 text-white">Details</h3>
        <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
            <tbody>
                <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700">
                    <td class="px-6 py-4 font-mono text-gray-900 dark:text-white">Request ID</td>
                    <td class="px-6 py-4 font-mono text-green-600 dark:text-green-400">{{ .Request.ID }}</td>
                </tr>
                <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700">
                    <td class="px-6 py-4 font-mono text-gray-900 dark:text-white">Description</td>
                    <td class="px-6 py-4 font-mono text-green-600 dark:text-green-400">{{ .Request.Description }}</td>
                </tr>
                <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700">
                    <td class="px-6 py-4 font-mono text-gray-900 dark:text-white">Requested By</td>
                    <td class="px-6 py-4 font-mono text-green-600 dark:text-green-400">{{ .Request.RequestedBy }}</td>
                </tr>
            </tbody>
        </table>
    </div>

    {{ if .Page.ErrMessage }}
    {{ template "partials/error_message" . }}
    {{ end }}

    <div class="flex space-x-4">
        <button @click="postApproval('approve')"
                class="focus:outline-none text-white bg-green-700 hover:bg-green-800 focus:ring-4 focus:ring-green-300 font-medium rounded-lg text-sm px-5 py-2.5 mb-2 dark:bg-green-600 dark:hover:bg-green-700 dark:focus:ring-green-800">
            Approve
        </button>
        <button @click="postApproval('reject')"
                class="focus:outline-none text-white bg-red-700 hover:bg-red-800 focus:ring-4 focus:ring-red-300 font-medium rounded-lg text-sm px-5 py-2.5 mb-2 dark:bg-red-600 dark:hover:bg-red-700 dark:focus:ring-red-900">
            Reject
        </button>
    </div>
</div>

<script>
function approvalComponent(approvalID) {
    return {
        approvalID: approvalID,
        async postApproval(action) {
            try {
                const response = await fetch(`/api/v1/approvals/${this.approvalID}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ action: action }),
                });
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || `HTTP error! status: ${response.status}`);
                }

                window.dispatchEvent(
                    new CustomEvent("notify", {
                        detail: { message: data.message || `Request ${action}ed successfully!`, type: "success" },
                    }),
                );
                // Optionally redirect or update UI after successful approval/rejection
                window.location.href = "/view/"; // Example: Redirect to flows list
            } catch (error) {
                console.error('Error:', error);
                window.dispatchEvent(
                    new CustomEvent("notify", {
                        detail: { message: error.message || "An error occurred during approval.", type: "error" },
                    }),
                );
            }
        }
    }
}
</script>

{{ template "partials/footer" . }}
{{ end }}
