{{ define "credential_management" }}
{{ template "partials/header" . }}
<div class="bg-gray-900 min-h-screen w-full">
    <div
        class="w-full max-w-7xl mx-auto px-4 sm:px-6 lg:px-8"
        x-data="credentialManagement()"
        x-init="fetchCredentials()"
    >
        <div class="py-10">
            <h1 class="text-2xl font-semibold text-white">Credentials Management</h1>
        </div>

        <!-- Search and Add Credential Section -->
        <div class="flex justify-between items-center mb-6">
            <input
                type="text"
                x-model="state.searchQuery"
                @input.debounce.500ms="fetchCredentials()"
                placeholder="Search credentials..."
                class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full max-w-lg p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500"
            />
            <button
                @click="openAddCredentialModal()"
                class="ml-4 text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800"
            >
                Add Credential
            </button>
        </div>

        <!-- Credentials Table -->
        <div class="mt-8 overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-700 bg-gray-800 rounded-lg shadow">
                <thead class="bg-gray-800">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Name</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Type</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Username</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Created</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-gray-800 divide-y divide-gray-700">
                    <template x-for="credential in state.credentials" :key="credential.id">
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-gray-500 dark:text-gray-300" x-text="credential.name"></td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span :class="{
                                    'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200': credential.type === 'ssh_key',
                                    'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200': credential.type === 'password'
                                }" class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium" x-text="credential.type.replace('_', ' ').toUpperCase()"></span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-gray-500 dark:text-gray-300" x-text="credential.username || '-'"></td>
                            <td class="px-6 py-4 whitespace-nowrap text-gray-500 dark:text-gray-300" x-text="new Date(credential.created_at).toLocaleDateString()"></td>
                            <td class="px-6 py-4 whitespace-nowrap text-gray-500 dark:text-gray-300">
                                <button class="inline-flex items-center px-3 py-1.5 text-xs font-medium text-blue-700 bg-blue-100 rounded hover:bg-blue-200 dark:bg-blue-900 dark:text-blue-200 dark:hover:bg-blue-800 mr-2" @click="editCredential(credential.id)">Edit</button>
                                <button class="inline-flex items-center px-3 py-1.5 text-xs font-medium text-red-700 bg-red-100 rounded hover:bg-red-200 dark:bg-red-900 dark:text-red-200 dark:hover:bg-red-800" @click="deleteCredential(credential.id)">Delete</button>
                            </td>
                        </tr>
                    </template>
                    <tr x-show="state.credentials.length === 0">
                        <td colspan="5" class="text-center px-6 py-4 text-gray-500 dark:text-gray-400">No credentials found.</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Pagination Controls -->
        <div class="flex justify-center mt-4" x-show="state.pageCount > 1">
            <div class="join">
                <button class="join-item btn btn-sm"
                    :class="{'btn-disabled': state.page === 1}"
                    @click="goToPage(state.page - 1)"
                    :disabled="state.page === 1"
                >Prev</button>
                <template x-for="p in state.pageCount" :key="p">
                    <button class="join-item btn btn-sm"
                        :class="{'btn-active': p === state.page}"
                        @click="goToPage(p)"
                        x-text="p"
                    ></button>
                </template>
                <button class="join-item btn btn-sm"
                    :class="{'btn-disabled': state.page === state.pageCount}"
                    @click="goToPage(state.page + 1)"
                    :disabled="state.page === state.pageCount"
                >Next</button>
            </div>
        </div>

        <!-- Credential Modal -->
        <div class="fixed inset-0 z-50 flex items-center justify-center bg-gray-900/60" x-show="modals.credential">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg w-full max-w-lg p-6">
                <h3 class="font-bold text-lg mb-4 text-gray-900 dark:text-white" x-text="modals.mode === 'add' ? 'Add Credential' : 'Edit Credential'"></h3>
                <form @submit.prevent="submitCredential">
                    <div class="mb-4">
                        <label class="block mb-1 font-medium text-gray-900 dark:text-white">Name</label>
                        <input type="text" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500" x-model="forms.credential.name" required />
                    </div>
                    <div class="mb-4">
                        <label class="block mb-1 font-medium text-gray-900 dark:text-white">Type</label>
                        <select class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500" x-model="forms.credential.type" @change="resetCredentialFields()" required>
                            <option value="">Select type</option>
                            <option value="ssh_key">SSH Key</option>
                            <option value="password">Password</option>
                        </select>
                    </div>
                    
                    <!-- Username field (for ssh_key and password types) -->
                    <div class="mb-4" x-show="forms.credential.type === 'ssh_key' || forms.credential.type === 'password'">
                        <label class="block mb-1 font-medium text-gray-900 dark:text-white">Username</label>
                        <input type="text" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500" x-model="forms.credential.username" />
                    </div>

                    <!-- Password field (for password type) -->
                    <div class="mb-4" x-show="forms.credential.type === 'password'">
                        <label class="block mb-1 font-medium text-gray-900 dark:text-white">Password</label>
                        <input type="password" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500" x-model="forms.credential.password" />
                    </div>

                    <!-- SSH Key fields (for ssh_key type) -->
                    <template x-if="forms.credential.type === 'ssh_key'">
                        <div>
                            <div class="mb-4">
                                <label class="block mb-1 font-medium text-gray-900 dark:text-white">Private Key</label>
                                <textarea class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500" x-model="forms.credential.private_key" rows="6" placeholder="-----BEGIN OPENSSH PRIVATE KEY-----"></textarea>
                            </div>
                            <div class="mb-4">
                                <label class="block mb-1 font-medium text-gray-900 dark:text-white">Passphrase (optional)</label>
                                <input type="password" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500" x-model="forms.credential.passphrase" />
                            </div>
                        </div>
                    </template>


                    <div class="mb-4">
                        <label class="block mb-1 font-medium text-gray-900 dark:text-white">Description</label>
                        <textarea class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500" x-model="forms.credential.description" rows="2"></textarea>
                    </div>

                    <div class="flex justify-end gap-2 mt-6">
                        <button type="button" class="inline-flex items-center px-5 py-2.5 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 dark:bg-gray-700 dark:text-gray-200 dark:hover:bg-gray-600" @click="closeCredentialModal()">Cancel</button>
                        <button type="submit" class="inline-flex items-center px-5 py-2.5 text-sm font-medium text-white bg-blue-700 rounded-lg hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800" x-text="modals.mode === 'add' ? 'Add' : 'Update'"></button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    function credentialManagement() {
        return {
            state: {
                credentials: [],
                searchQuery: "",
                page: 1,
                count: 10,
                pageCount: 1,
                totalCount: 0,
                loading: false
            },

            modals: {
                credential: false,
                mode: 'add',
                currentCredentialId: null
            },

            forms: {
                credential: {
                    name: "",
                    type: "",
                    username: "",
                    password: "",
                    private_key: "",
                    passphrase: "",
                    token: "",
                    description: ""
                }
            },

            fetchCredentials() {
                this.state.loading = true;
                let url = `/api/v1/{{ .Page.Namespace }}/credentials?page=${this.state.page}&count_per_page=${this.state.count}`;
                if (this.state.searchQuery) {
                    url += `&filter=${encodeURIComponent(this.state.searchQuery)}`;
                }

                fetch(url)
                    .then(res => res.json())
                    .then(data => {
                        this.state.credentials = (data.credentials || []).map(cred => ({
                            ...cred,
                            type: cred.private_key ? 'ssh_key' : 'password',
                            username: cred.username || '-',
                            created_at: new Date().toISOString()
                        }));
                        this.state.pageCount = data.page_count || 1;
                        this.state.totalCount = data.total_count || 0;
                    })
                    .catch(err => {
                        this.notifyError(err.message || "Failed to fetch credentials");
                        this.state.credentials = [];
                        this.state.pageCount = 1;
                    })
                    .finally(() => {
                        this.state.loading = false;
                    });
            },

            openAddCredentialModal() {
                this.modals.mode = 'add';
                this.modals.currentCredentialId = null;
                this.forms.credential = {
                    name: "",
                    type: "",
                    username: "",
                    password: "",
                    private_key: "",
                    passphrase: "",
                    token: "",
                    description: ""
                };
                this.modals.credential = true;
            },

            getCredential(id) {
                return fetch(`/api/v1/{{ .Page.Namespace }}/credentials/${id}`)
                    .then(res => {
                        if (!res.ok) throw new Error("Failed to fetch credential");
                        return res.json();
                    });
            },

            editCredential(id) {
                this.modals.mode = 'edit';
                this.modals.currentCredentialId = id;
                this.modals.credential = true;
                
                this.getCredential(id)
                    .then(credential => {
                        this.forms.credential = {
                            name: credential.name,
                            type: credential.private_key ? 'ssh_key' : 'password',
                            username: credential.username || "",
                            password: "",
                            private_key: "",
                            passphrase: "",
                            description: credential.description || ""
                        };
                    })
                    .catch(err => {
                        this.notifyError(err.message || "Failed to load credential details");
                        this.closeCredentialModal();
                    });
            },

            closeCredentialModal() {
                this.modals.credential = false;
            },

            resetCredentialFields() {
                this.forms.credential.username = "";
                this.forms.credential.password = "";
                this.forms.credential.private_key = "";
                this.forms.credential.passphrase = "";
            },

            submitCredential() {
                const payload = {
                    name: this.forms.credential.name
                };

                if (this.forms.credential.type === 'ssh_key') {
                    payload.private_key = this.forms.credential.private_key;
                    if (this.forms.credential.passphrase) {
                        payload.passphrase = this.forms.credential.passphrase;
                    }
                } else if (this.forms.credential.type === 'password') {
                    if (this.forms.credential.password) {
                        payload.password = this.forms.credential.password;
                    }
                }

                const url = this.modals.mode === 'add'
                    ? '/api/v1/{{ .Page.Namespace }}/credentials'
                    : `/api/v1/{{ .Page.Namespace }}/credentials/${this.modals.currentCredentialId}`;

                const method = this.modals.mode === 'add' ? 'POST' : 'PUT';

                fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                })
                .then(res => {
                    if (!res.ok) throw new Error(`Failed to ${this.modals.mode} credential`);
                    return res.json();
                })
                .then(() => {
                    this.closeCredentialModal();
                    this.fetchCredentials();
                    this.notifySuccess(`Credential ${this.modals.mode === 'add' ? 'added' : 'updated'} successfully`);
                })
                .catch(err => {
                    this.notifyError(err.message || `Failed to ${this.modals.mode} credential`);
                });
            },

            deleteCredential(id) {
                if (confirm("Are you sure you want to delete this credential?")) {
                    fetch(`/api/v1/{{ .Page.Namespace }}/credentials/${id}`, {
                        method: 'DELETE'
                    })
                    .then(res => {
                        if (!res.ok) throw new Error("Failed to delete credential");
                    })
                    .then(() => {
                        this.fetchCredentials();
                        this.notifySuccess("Credential deleted successfully");
                    })
                    .catch(err => {
                        this.notifyError(err.message || "Failed to delete credential");
                    });
                }
            },

            goToPage(p) {
                if (p < 1 || p > this.state.pageCount) return;
                this.state.page = p;
                this.fetchCredentials();
            },

            notifySuccess(message) {
                window.dispatchEvent(
                    new CustomEvent("notify", {
                        detail: { message, type: "success" },
                    })
                );
            },

            notifyError(message) {
                window.dispatchEvent(
                    new CustomEvent("notify", {
                        detail: { message, type: "error" },
                    })
                );
            }
        };
    }
</script>
{{ template "partials/footer" . }}
{{ end }}