{{ define "flow_create" }}
{{ template "partials/header" . }}

<div class="flex h-screen bg-gray-50">
    <!-- Sidebar -->
    {{ template "partials/sidebar" . }}

    <!-- Main Content -->
    <div x-data="flowCreator()" class="flex-1 flex flex-col overflow-hidden">
        <!-- Header -->
        <header class="bg-white border-b border-gray-200 px-6 py-4">
            <div class="flex items-center justify-between">
                {{ template "partials/breadcrumb" . }}

                <!-- Actions -->
                <div class="flex items-center gap-4">
                    <button @click="showYamlPreview = true"
                        class="inline-flex items-center gap-2 px-4 py-2 bg-white border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 transition-colors">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" />
                        </svg>
                        View YAML
                    </button>
                    <button @click="validateFlow()"
                        class="inline-flex items-center gap-2 px-4 py-2 bg-white border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 transition-colors">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        Validate
                    </button>
                    <button @click="saveFlow()"
                        class="inline-flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V2" />
                        </svg>
                        Save Flow
                    </button>
                </div>
            </div>
        </header>

        <!-- Page Content -->
        <div class="flex-1 overflow-y-auto">
            <div class="max-w-6xl mx-auto p-6">
                <!-- Flow Metadata Section -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        Flow Information
                    </h2>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="flow-id" class="block text-sm font-medium text-gray-700 mb-2">Flow ID *</label>
                            <input type="text" id="flow-id" x-model="flow.metadata.id"
                                @input="flow.metadata.id = $event.target.value.replace(/[^a-zA-Z0-9_]/g, '')"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                placeholder="unique_flow_id">
                            <p class="mt-1 text-xs text-gray-500">Alphanumeric and underscores only</p>
                        </div>
                        <div>
                            <label for="flow-name" class="block text-sm font-medium text-gray-700 mb-2">Flow Name *</label>
                            <input type="text" id="flow-name" x-model="flow.metadata.name"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                placeholder="My Flow Name">
                        </div>
                        <div class="col-span-2">
                            <label for="flow-description" class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                            <textarea id="flow-description" x-model="flow.metadata.description"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none h-20"
                                placeholder="Describe what this flow does..."></textarea>
                        </div>
                    </div>
                </div>

                <!-- Flow Inputs Section -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4 flex items-center justify-between">
                        <span class="flex items-center gap-2">
                            <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1" />
                            </svg>
                            Flow Inputs
                        </span>
                        <button @click="addInput()"
                            class="text-sm text-blue-600 hover:text-blue-700 font-medium">+ Add Input</button>
                    </h2>

                    <div class="space-y-4">
                        <template x-for="(input, index) in flow.inputs" :key="index">
                            <div class="border border-gray-200 rounded-lg p-4 relative slide-down">
                                <button @click="removeInput(index)"
                                    class="absolute top-4 right-4 text-gray-400 hover:text-red-600">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>

                                <div class="grid grid-cols-3 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Input Name *</label>
                                        <input type="text" x-model="input.name"
                                            @input="input.name = $event.target.value.replace(/[^a-zA-Z0-9_]/g, '')"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                                            placeholder="input_name">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Type *</label>
                                        <select x-model="input.type" @change="onInputTypeChange(input)"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm">
                                            <option value="string">String</option>
                                            <option value="number">Number</option>
                                            <option value="boolean">Boolean</option>
                                            <option value="password">Password</option>
                                            <option value="file">File</option>
                                            <option value="datetime">DateTime</option>
                                            <option value="select">Select</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Label</label>
                                        <input type="text" x-model="input.label"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                                            placeholder="Display Label">
                                    </div>
                                    <div class="col-span-2">
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                                        <input type="text" x-model="input.description"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                                            placeholder="Help text for this input">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Default Value</label>
                                        <input type="text" x-model="input.default"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                                            placeholder="Default value">
                                    </div>
                                    <div class="col-span-2">
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Validation</label>
                                        <input type="text" x-model="input.validation"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm font-mono"
                                            placeholder="len(input_name) > 3">
                                    </div>
                                    <div class="flex items-center">
                                        <input type="checkbox" x-model="input.required"
                                            class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                        <label class="ml-2 block text-sm text-gray-700">Required</label>
                                    </div>
                                </div>

                                <!-- Options for select type -->
                                <div x-show="input.type === 'select'" class="mt-4 p-3 bg-gray-50 rounded-md">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Options (one per line)</label>
                                    <textarea x-model="input.optionsText" @input="updateOptions(input)"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm font-mono h-20"
                                        placeholder="option1&#10;option2&#10;option3"></textarea>
                                </div>
                            </div>
                        </template>

                        <div x-show="flow.inputs.length === 0" class="text-center py-8 text-gray-500">
                            <svg class="mx-auto h-12 w-12 text-gray-400 mb-3" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            <p>No inputs defined yet</p>
                            <button @click="addInput()"
                                class="mt-2 text-sm text-blue-600 hover:text-blue-700 font-medium">Add your first input</button>
                        </div>
                    </div>
                </div>

                <!-- Flow Actions Section -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4 flex items-center justify-between">
                        <span class="flex items-center gap-2">
                            <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M13 10V3L4 14h7v7l9-11h-7z" />
                            </svg>
                            Flow Actions
                        </span>
                        <button @click="addAction()"
                            class="text-sm text-blue-600 hover:text-blue-700 font-medium">+ Add Action</button>
                    </h2>

                    <div class="space-y-4">
                        <template x-for="(action, index) in flow.actions" :key="action.tempId">
                            <div class="border border-gray-200 rounded-lg overflow-hidden slide-down"
                                draggable="true" @dragstart="dragStart($event, index)" @dragend="dragEnd($event)"
                                @dragover.prevent="dragOver($event)" @dragleave="dragLeave($event)"
                                @drop.prevent="drop($event, index)">
                                <!-- Action Header -->
                                <div class="bg-gray-50 px-4 py-3 flex items-center justify-between cursor-move">
                                    <div class="flex items-center gap-3">
                                        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor"
                                            viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M4 6h16M4 12h16M4 18h16" />
                                        </svg>
                                        <span class="font-medium text-gray-900"
                                            x-text="action.name || 'Untitled Action'"></span>
                                        <span class="text-xs px-2 py-1 bg-gray-200 text-gray-700 rounded-full"
                                            x-text="action.executor || 'No executor'"></span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <button @click="action.collapsed = !action.collapsed"
                                            class="text-gray-400 hover:text-gray-600">
                                            <svg class="w-5 h-5 transform transition-transform"
                                                :class="{ 'rotate-180': !action.collapsed }" fill="none"
                                                stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round"
                                                    stroke-width="2" d="M19 9l-7 7-7-7" />
                                            </svg>
                                        </button>
                                        <button @click="duplicateAction(index)" class="text-gray-400 hover:text-blue-600">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                                            </svg>
                                        </button>
                                        <button @click="removeAction(index)" class="text-gray-400 hover:text-red-600">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                            </svg>
                                        </button>
                                    </div>
                                </div>

                                <!-- Action Content -->
                                <div x-show="!action.collapsed" class="p-4 space-y-4">
                                    <!-- Basic Action Fields -->
                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Action ID *</label>
                                            <input type="text" x-model="action.id"
                                                @input="action.id = $event.target.value.replace(/[^a-zA-Z0-9_]/g, '')"
                                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                                                placeholder="action_id">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Action Name *</label>
                                            <input type="text" x-model="action.name"
                                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                                                placeholder="Action Display Name">
                                        </div>
                                    </div>

                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Executor *</label>
                                            <select x-model="action.executor" @change="onExecutorChange(action)"
                                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm">
                                                <option value="">Select Executor</option>
                                                <template x-for="executor in availableExecutors" :key="executor.name">
                                                    <option :value="executor.name" x-text="executor.display_name || executor.name"></option>
                                                </template>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Run On</label>
                                            <input type="text" x-model="action.on"
                                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                                                placeholder="local,prod-worker-01">
                                            <p class="mt-1 text-xs text-gray-500">Comma-separated node names</p>
                                        </div>
                                    </div>

                                    <!-- Dynamic Executor Configuration -->
                                    <div x-show="action.executor && executorConfigs[action.executor]" class="space-y-4">
                                        <div class="border-t pt-4">
                                            <h4 class="text-sm font-medium text-gray-900 mb-3 flex items-center gap-2">
                                                <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor"
                                                    viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                        d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                        d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                                </svg>
                                                <span x-text="action.executor.charAt(0).toUpperCase() + action.executor.slice(1)"></span>
                                                Configuration
                                            </h4>

                                            <!-- Dynamic config fields will be rendered here -->
                                            <div id="executor-config" x-html="renderExecutorConfig(action)"></div>
                                        </div>
                                    </div>

                                    <!-- Environment Variables -->
                                    <div>
                                        <div class="flex items-center justify-between mb-2">
                                            <label class="block text-sm font-medium text-gray-700">Environment Variables</label>
                                            <button @click="addVariable(action)" type="button"
                                                class="text-xs text-blue-600 hover:text-blue-700">+ Add Variable</button>
                                        </div>
                                        <div class="space-y-2">
                                            <template x-for="(variable, varIndex) in action.variables" :key="varIndex">
                                                <div class="flex items-center gap-2">
                                                    <input type="text" x-model="variable.name" placeholder="VAR_NAME"
                                                        class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm font-mono">
                                                    <span class="text-gray-500">=</span>
                                                    <input type="text" x-model="variable.value"
                                                        class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm font-mono">
                                                    <button @click="removeVariable(action, varIndex)" type="button"
                                                        class="text-gray-400 hover:text-red-600">
                                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round"
                                                                stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                                        </svg>
                                                    </button>
                                                </div>
                                            </template>
                                        </div>
                                    </div>

                                    <!-- Additional Options -->
                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Condition</label>
                                            <input type="text" x-model="action.condition"
                                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm font-mono"
                                                >
                                            <p class="mt-1 text-xs text-gray-500">Action runs only if condition is true</p>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Artifacts</label>
                                            <input type="text" x-model="action.artifactsText" @input="updateArtifacts(action)"
                                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                                                placeholder="/path/to/file1, /path/to/file2">
                                            <p class="mt-1 text-xs text-gray-500">Comma-separated file paths</p>
                                        </div>
                                    </div>

                                    <div class="flex items-center">
                                        <input type="checkbox" x-model="action.approval"
                                            class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                        <label class="ml-2 block text-sm text-gray-700">Require approval before execution</label>
                                    </div>
                                </div>
                            </div>
                        </template>

                        <div x-show="flow.actions.length === 0"
                            class="text-center py-12 text-gray-500 border-2 border-dashed border-gray-300 rounded-lg">
                            <svg class="mx-auto h-12 w-12 text-gray-400 mb-3" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M13 10V3L4 14h7v7l9-11h-7z" />
                            </svg>
                            <p>No actions defined yet</p>
                            <button @click="addAction()"
                                class="mt-2 text-sm text-blue-600 hover:text-blue-700 font-medium">Add your first action</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- YAML Preview Modal -->
<div x-show="showYamlPreview"
    class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
    <div class="bg-white rounded-xl p-6 max-w-4xl w-full mx-4 max-h-[90vh] flex flex-col">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold text-gray-900">Flow YAML Preview</h3>
            <button @click="showYamlPreview = false" class="text-gray-400 hover:text-gray-500">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        <div class="flex-1 overflow-hidden">
            <div id="yaml-preview" class="h-full border border-gray-300 rounded-md"></div>
        </div>
        <div class="flex justify-end gap-3 mt-4 pt-4 border-t">
            <button @click="copyYaml()"
                class="px-4 py-2 bg-white border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 transition-colors">
                Copy to Clipboard
            </button>
            <button @click="downloadYaml()"
                class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">
                Download YAML
            </button>
        </div>
    </div>
</div>

<!-- Validation Result Modal -->
<div x-show="showValidation"
    class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
    <div class="bg-white rounded-xl p-6 max-w-2xl w-full mx-4">
        <div class="flex items-center mb-4">
            <div class="w-12 h-12 rounded-full flex items-center justify-center mr-4"
                :class="validationResult.success ? 'bg-green-100' : 'bg-red-100'">
                <svg x-show="validationResult.success" class="w-6 h-6 text-green-600" fill="none"
                    stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <svg x-show="!validationResult.success" class="w-6 h-6 text-red-600" fill="none"
                    stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
            </div>
            <div>
                <h3 class="text-lg font-semibold text-gray-900"
                    x-text="validationResult.success ? 'Validation Passed' : 'Validation Failed'"></h3>
                <p class="text-sm text-gray-600"
                    x-text="validationResult.success ? 'Your flow definition is valid.' : 'Please fix the following issues:'">
                </p>
            </div>
        </div>

        <div x-show="!validationResult.success && validationResult.errors.length > 0" class="space-y-2 mb-4">
            <template x-for="error in validationResult.errors" :key="error">
                <div class="flex items-start gap-2 text-sm">
                    <svg class="w-4 h-4 text-red-500 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor"
                        viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span class="text-gray-700" x-text="error"></span>
                </div>
            </template>
        </div>

        <div class="flex justify-end">
            <button @click="showValidation = false"
                class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition-colors">
                Close
            </button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.2/lib/codemirror.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.2/mode/yaml/yaml.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.2/mode/shell/shell.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.65.2/lib/codemirror.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.65.2/theme/default.min.css">
<script>
    // Initialize CodeMirror when loaded
    window.codeMirrorLoaded = true;
    window.dispatchEvent(new CustomEvent('codeMirrorReady'));

    function flowCreator() {
        return {
            selectedNamespace: '{{ .Page.Namespace }}',
            flow: {
                metadata: {
                    id: '',
                    name: '',
                    description: '',
                    namespace: '{{ .Page.Namespace }}'
                },
                inputs: [],
                actions: []
            },
            showYamlPreview: false,
            showValidation: false,
            validationResult: {
                success: false,
                errors: []
            },
            availableExecutors: [],
            executorConfigs: {},
            codeMirrorEditors: {},
            yamlEditor: null,
            draggedIndex: null,
            loading: false,
            errorMessage: '',

            init() {
                this.loadExecutors();
                this.addAction();
                
                // Watch for YAML preview modal
                this.$watch('showYamlPreview', (value) => {
                    if (value) {
                        this.$nextTick(() => {
                            this.initializeYamlPreview();
                        });
                    }
                });
            },

            async loadExecutors() {
                this.loading = true;
                this.errorMessage = '';

                try {
                    const response = await fetch('/api/v1/executors', {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        this.notifyError(data.error || 'Failed to load executors');
                        this.availableExecutors = [];
                        return;
                    }

                    // API returns { executors: ["docker", "script"] }, transform to expected format
                    this.availableExecutors = data.executors.map(name => ({
                        name: name,
                        display_name: name.charAt(0).toUpperCase() + name.slice(1)
                    }));
                } catch (error) {
                    console.error('Error loading executors:', error);
                    this.notifyError('Failed to load executors');
                    this.availableExecutors = [];
                } finally {
                    this.loading = false;
                }
            },

            initializeYamlPreview() {
                if (window.codeMirrorLoaded) {
                    this.createYamlEditor();
                } else {
                    window.addEventListener('codeMirrorReady', () => {
                        this.createYamlEditor();
                    });
                }
            },

            createYamlEditor() {
                const element = document.getElementById('yaml-preview');
                if (element && !this.yamlEditor) {
                    this.yamlEditor = CodeMirror(element, {
                        value: this.generateYaml(),
                        mode: 'yaml',
                        theme: 'default',
                        readOnly: true,
                        lineNumbers: true,
                        lineWrapping: true
                    });
                } else if (this.yamlEditor) {
                    this.yamlEditor.setValue(this.generateYaml());
                }
            },

            // Input management
            addInput() {
                this.flow.inputs.push({
                    name: '',
                    type: 'string',
                    label: '',
                    description: '',
                    required: false,
                    default: '',
                    validation: '',
                    options: [],
                    optionsText: ''
                });
            },

            removeInput(index) {
                this.flow.inputs.splice(index, 1);
            },

            onInputTypeChange(input) {
                if (input.type !== 'select') {
                    input.options = [];
                    input.optionsText = '';
                }
            },

            updateOptions(input) {
                input.options = input.optionsText.split('\n').filter(opt => opt.trim());
            },

            // Action management
            addAction() {
                const tempId = Date.now() + Math.random();
                const action = {
                    tempId: tempId,
                    id: '',
                    name: '',
                    executor: '',
                    with: {},
                    on: '',
                    variables: [],
                    approval: false,
                    artifacts: [],
                    artifactsText: '',
                    condition: '',
                    collapsed: false
                };

                this.flow.actions.push(action);
            },

            removeAction(index) {
                this.flow.actions.splice(index, 1);
            },

            duplicateAction(index) {
                const original = this.flow.actions[index];
                const tempId = Date.now() + Math.random();
                const duplicate = JSON.parse(JSON.stringify(original));

                duplicate.tempId = tempId;
                duplicate.id = original.id ? original.id + '_copy' : '';
                duplicate.name = original.name ? original.name + ' (Copy)' : '';

                this.flow.actions.splice(index + 1, 0, duplicate);
            },

            async onExecutorChange(action) {
                if (!action.executor) {
                    action.with = {};
                    return;
                }

                try {
                    const response = await fetch(`/api/v1/executors/${action.executor}/config`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });

                    const config = await response.json();

                    if (!response.ok) {
                        this.notifyError(config.error || `Failed to load config for ${action.executor}`);
                        return;
                    }

                    this.executorConfigs[action.executor] = config;
                    action.with = {};
                    
                    // Initialize with default values
                    if (config.$defs && config.$ref) {
                        // Handle JSON Schema $defs structure
                        const refPath = config.$ref.replace('#/$defs/', '');
                        const schema = config.$defs[refPath];
                        if (schema && schema.properties) {
                            Object.entries(schema.properties).forEach(([key, property]) => {
                                if (property.default !== undefined) {
                                    action.with[key] = property.default;
                                }
                            });
                        }
                        // Store the resolved schema for rendering
                        this.executorConfigs[action.executor] = schema || config;
                    } else if (config.properties) {
                        Object.entries(config.properties).forEach(([key, property]) => {
                            if (property.default !== undefined) {
                                action.with[key] = property.default;
                            }
                        });
                    }

                    // Re-render the config fields
                    this.$nextTick(() => {
                        this.initializeCodeMirrorEditors(action);
                    });
                } catch (error) {
                    console.error('Error loading executor config:', error);
                    this.notifyError(`Failed to load config for ${action.executor}`);
                }
            },

            renderExecutorConfig(action) {
                const config = this.executorConfigs[action.executor];
                if (!config || !config.properties) return '';

                let html = '<div class="space-y-4">';
                for (const [key, property] of Object.entries(config.properties)) {
                    const isRequired = config.required && config.required.includes(key);
                    html += this.renderConfigField(action, key, property, isRequired);
                }
                html += '</div>';
                return html;
            },

            renderConfigField(action, key, property, isRequired) {
                const requiredAttr = isRequired ? 'required' : '';
                const label = property.title || key;
                const description = property.description || '';
                const placeholder = property.examples?.[0] || property.default || '';

                if (property.type === 'boolean') {
                    return `
                        <div class="flex items-start">
                            <input type="checkbox" 
                                   x-model="action.with['${key}']"
                                   class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded mt-0.5">
                            <div class="ml-2">
                                <label class="text-sm text-gray-700">${label}</label>
                                ${description ? `<p class="text-xs text-gray-500">${description}</p>` : ''}
                            </div>
                        </div>
                    `;
                } else if (property.enum) {
                    const options = property.enum.map(option => 
                        `<option value="${option}">${option}</option>`
                    ).join('');
                    return `
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">${label}</label>
                            <select x-model="action.with['${key}']" ${requiredAttr}
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm">
                                <option value="">Select...</option>
                                ${options}
                            </select>
                            ${description ? `<p class="mt-1 text-xs text-gray-500">${description}</p>` : ''}
                        </div>
                    `;
                } else if (property.type === 'number' || property.type === 'integer') {
                    const step = property.type === 'integer' ? '1' : 'any';
                    const min = property.minimum !== undefined ? `min="${property.minimum}"` : '';
                    const max = property.maximum !== undefined ? `max="${property.maximum}"` : '';
                    return `
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">${label}</label>
                            <input type="number" 
                                   x-model.number="action.with['${key}']"
                                   placeholder="${placeholder}"
                                   step="${step}" ${min} ${max} ${requiredAttr}
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm">
                            ${description ? `<p class="mt-1 text-xs text-gray-500">${description}</p>` : ''}
                        </div>
                    `;
                } else if (property.format === 'textarea' || property.widget === 'codeeditor' || !this.isPrimitiveType(property.type)) {
                    return `
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">${label}</label>
                            <div id="editor-${action.tempId}-${key}" class="border border-gray-300 rounded-md" style="height: 200px;"></div>
                            ${description ? `<p class="mt-1 text-xs text-gray-500">${description}</p>` : ''}
                        </div>
                    `;
                } else {
                    const inputType = property.format === 'password' ? 'password' : 'text';
                    return `
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">${label}</label>
                            <input type="${inputType}" 
                                   x-model="action.with['${key}']"
                                   placeholder="${placeholder}" ${requiredAttr}
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm">
                            ${description ? `<p class="mt-1 text-xs text-gray-500">${description}</p>` : ''}
                        </div>
                    `;
                }
            },

            isPrimitiveType(type) {
                return ['string', 'number', 'integer', 'boolean'].includes(type);
            },

            initializeCodeMirrorEditors(action) {
                if (!window.codeMirrorLoaded) {
                    window.addEventListener('codeMirrorReady', () => {
                        this.initializeCodeMirrorEditors(action);
                    });
                    return;
                }

                const config = this.executorConfigs[action.executor];
                if (!config || !config.properties) return;

                Object.entries(config.properties).forEach(([key, property]) => {
                    if (property.format === 'textarea' || property.widget === 'codeeditor' || !this.isPrimitiveType(property.type)) {
                        const editorId = `editor-${action.tempId}-${key}`;
                        const element = document.getElementById(editorId);
                        
                        if (element && !this.codeMirrorEditors[editorId]) {
                            let mode = 'yaml';
                            if (property.format === 'textarea' || property.widget === 'codeeditor') {
                                mode = 'shell';
                            }
                            
                            const editor = CodeMirror(element, {
                                value: action.with[key] || property.default || '',
                                mode: mode,
                                theme: 'default',
                                lineNumbers: true,
                                lineWrapping: true
                            });

                            editor.on('change', () => {
                                action.with[key] = editor.getValue();
                            });

                            this.codeMirrorEditors[editorId] = editor;
                        }
                    }
                });
            },

            // Variable management
            addVariable(action) {
                if (!action.variables) {
                    action.variables = [];
                }
                action.variables.push({ name: '', value: '' });
            },

            removeVariable(action, index) {
                action.variables.splice(index, 1);
            },

            updateArtifacts(action) {
                action.artifacts = action.artifactsText.split(',').map(a => a.trim()).filter(a => a);
            },

            // Drag and drop
            dragStart(event, index) {
                this.draggedIndex = index;
                event.target.classList.add('dragging');
            },

            dragEnd(event) {
                event.target.classList.remove('dragging');
                this.draggedIndex = null;
            },

            dragOver(event) {
                event.currentTarget.classList.add('drag-over');
            },

            dragLeave(event) {
                event.currentTarget.classList.remove('drag-over');
            },

            drop(event, dropIndex) {
                event.currentTarget.classList.remove('drag-over');
                if (this.draggedIndex !== null && this.draggedIndex !== dropIndex) {
                    const dragged = this.flow.actions.splice(this.draggedIndex, 1)[0];
                    this.flow.actions.splice(dropIndex, 0, dragged);
                }
            },

            // YAML generation
            generateYaml() {
                const flowObj = {
                    metadata: this.flow.metadata,
                    inputs: this.flow.inputs.filter(i => i.name).map(input => {
                        const cleanInput = { name: input.name, type: input.type };
                        if (input.label) cleanInput.label = input.label;
                        if (input.description) cleanInput.description = input.description;
                        if (input.required) cleanInput.required = true;
                        if (input.default) cleanInput.default = input.default;
                        if (input.validation) cleanInput.validation = input.validation;
                        if (input.type === 'select' && input.options.length > 0) cleanInput.options = input.options;
                        return cleanInput;
                    }),
                    actions: this.flow.actions.filter(a => a.id).map(action => {
                        const cleanAction = {
                            id: action.id,
                            name: action.name,
                            executor: action.executor,
                            with: action.with || {}
                        };
                        if (action.on) cleanAction.on = action.on.split(',').map(s => s.trim()).filter(s => s);
                        if (action.variables && action.variables.length > 0) {
                            cleanAction.variables = action.variables.filter(v => v.name && v.value).reduce((acc, v) => ({ ...acc, [v.name]: v.value }), {});
                        }
                        if (action.approval) cleanAction.approval = true;
                        if (action.artifacts && action.artifacts.length > 0) cleanAction.artifacts = action.artifacts;
                        if (action.condition) cleanAction.condition = action.condition;
                        return cleanAction;
                    })
                };

                return this.objectToYaml(flowObj);
            },

            objectToYaml(obj, indent = 0) {
                let yamlString = '';
                const space = '  '.repeat(indent);
                for (const key in obj) {
                    if (obj[key] !== null && typeof obj[key] === 'object' && !Array.isArray(obj[key])) {
                        yamlString += `${space}${key}:\n${this.objectToYaml(obj[key], indent + 1)}`;
                    } else if (Array.isArray(obj[key])) {
                        yamlString += `${space}${key}:\n`;
                        obj[key].forEach(item => {
                            if (typeof item === 'object') {
                                const itemYaml = this.objectToYaml(item, indent + 2).trimLeft();
                                yamlString += `${space}  - ${itemYaml}\n`;
                            } else {
                                yamlString += `${space}  - ${item}\n`;
                            }
                        });
                    } else if (obj[key] !== null && obj[key] !== undefined && obj[key] !== '') {
                        if (typeof obj[key] === 'string' && obj[key].includes('\n')) {
                            const scriptLines = obj[key].split('\n').map(line => `${space}    ${line}`).join('\n');
                            yamlString += `${space}${key}: |\n${scriptLines}\n`;
                        } else {
                            yamlString += `${space}${key}: ${obj[key]}\n`;
                        }
                    }
                }
                return yamlString;
            },

            validateFlow() {
                const errors = [];

                // Validate metadata
                if (!this.flow.metadata.id) errors.push('Flow ID is required');
                if (!/^[a-zA-Z0-9_]+$/.test(this.flow.metadata.id)) errors.push('Flow ID must be alphanumeric with underscores only');
                if (!this.flow.metadata.name) errors.push('Flow Name is required');

                // Validate inputs
                const inputNames = new Set();
                this.flow.inputs.forEach((input, i) => {
                    if (!input.name) errors.push(`Input #${i+1} is missing a name`);
                    else if (inputNames.has(input.name)) errors.push(`Duplicate input name: ${input.name}`);
                    else inputNames.add(input.name);

                    if (!input.type) errors.push(`Input "${input.name || i+1}" is missing a type`);
                });

                // Validate actions
                const actionIds = new Set();
                this.flow.actions.forEach((action, i) => {
                    if (!action.id) errors.push(`Action #${i+1} (${action.name || 'Untitled'}) is missing an ID`);
                    else if (actionIds.has(action.id)) errors.push(`Duplicate action ID: ${action.id}`);
                    else actionIds.add(action.id);

                    if (!action.name) errors.push(`Action #${i+1} is missing a name`);
                    if (!action.executor) errors.push(`Action "${action.name || i+1}" is missing an executor`);
                });

                this.validationResult = { success: errors.length === 0, errors: errors };
                this.showValidation = true;
                return errors.length === 0;
            },

            async saveFlow() {
                if (this.validateFlow()) {
                    try {
                        const yaml = this.generateYaml();
                        console.log("Flow YAML:", yaml);
                        
                        // TODO: Implement actual API call
                        // const response = await fetch(`/api/v1/${this.selectedNamespace}/flows`, {
                        //     method: 'POST',
                        //     headers: { 'Content-Type': 'application/yaml' },
                        //     body: yaml
                        // });
                        
                        this.notifySuccess('Flow validation passed! Check console for YAML output.');
                    } catch (error) {
                        console.error('Error saving flow:', error);
                        this.notifyError('Failed to save flow');
                    }
                }
            },

            copyYaml() {
                navigator.clipboard.writeText(this.generateYaml()).then(() =>
                    this.notifySuccess('YAML copied to clipboard!')
                );
            },

            downloadYaml() {
                const blob = new Blob([this.generateYaml()], { type: 'text/yaml' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${this.flow.metadata.id || 'flow'}.yaml`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            },

            notifySuccess(message) {
                window.dispatchEvent(
                    new CustomEvent("notify", {
                        detail: { message, type: "success" },
                    })
                );
            },

            notifyError(message) {
                window.dispatchEvent(
                    new CustomEvent("notify", {
                        detail: { message, type: "error" },
                    })
                );
            }
        };
    }
</script>

<style>
    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .slide-down {
        animation: slideDown 0.3s ease-out;
    }

    .dragging {
        opacity: 0.5;
    }

    .drag-over {
        background-color: #eff6ff;
        border-color: #3b82f6;
    }
</style>

{{ template "partials/footer" . }}
{{ end }}