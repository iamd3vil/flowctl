{{ define "flow_status" }}
{{ template "partials/header" . }}

<div class="flex h-screen bg-gray-50"
     x-data="flowStatusComponent('{{ .LogID }}', {{ toJson .Actions }})">
    <!-- Sidebar -->
    {{ template "partials/sidebar" . }}

    <!-- Main Content -->
    <main class="flex-1 flex flex-col overflow-hidden">
        <!-- Header -->
        <header class="bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center shadow-sm">
            <div class="flex items-center gap-5">
                <div class="flex items-center text-sm text-gray-500">
                    <span>Flows</span>
                    <span class="mx-2">/</span>
                    <span class="text-gray-900" x-text="flowName || '{{ .Flow.Meta.Name }}'"></span>
                    <span class="mx-2">/</span>
                    <span class="text-gray-900">Execution Status</span>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <div class="flex items-center gap-2">
                    <span class="text-sm text-gray-500">Status:</span>
                    <span x-show="status === 'running'" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                        <svg class="w-3 h-3 mr-1 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                        Running
                    </span>
                    <span x-show="status === 'completed'" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                        <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        Completed
                    </span>
                    <span x-show="status === 'failed'" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                        <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        Failed
                    </span>
                    <span x-show="status === 'awaiting_approval'" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                        <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        Awaiting Approval
                    </span>
                </div>
                <button onclick="window.history.back()" class="inline-flex items-center gap-2 px-4 py-2 bg-white border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 transition-colors">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                    </svg>
                    Back to Flows
                </button>
            </div>
        </header>

        <!-- Page Content -->
        <div class="flex-1 overflow-y-auto p-6 bg-gray-50">
            <div class="max-w-7xl mx-auto">
                <!-- Flow Info Card -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
                    <div class="flex justify-between items-start">
                        <div>
                            <h1 class="text-2xl font-semibold text-gray-900" x-text="flowName || '{{ .Flow.Meta.Name }}'"></h1>
                            <p class="text-gray-600 mt-1">Started at <span x-text="startTime"></span></p>
                        </div>
                        <div class="text-right">
                            <p class="text-sm text-gray-500">Execution ID</p>
                            <p class="font-mono text-sm text-gray-900">{{ .LogID }}</p>
                        </div>
                    </div>
                </div>

                <!-- Pipeline Progress -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">Pipeline Progress</h2>
                    <div class="flex gap-4 overflow-x-auto pb-2">
                        <template x-for="(action, index) in actions" :key="action.id">
                            <div class="min-w-[200px] p-4 rounded-lg border-2 transition-all duration-300 relative"
                                 :class="{
                                     'bg-red-50 border-red-500': index === failedActionIndex,
                                     'bg-green-50 border-green-500': completedActions.includes(index) && index !== failedActionIndex,
                                     'bg-blue-50 border-blue-500': index === currentActionIndex && status === 'running' && index !== failedActionIndex,
                                     'bg-gray-50 border-gray-300': index !== failedActionIndex && !completedActions.includes(index) && index !== currentActionIndex
                                 }">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="font-semibold text-gray-900" x-text="action.name || `Step ${index + 1}`"></span>
                                    <div class="w-6 h-6 rounded-full flex items-center justify-center text-white text-xs"
                                         :class="{
                                             'bg-red-500': index === failedActionIndex,
                                             'bg-green-500': completedActions.includes(index) && index !== failedActionIndex,
                                             'bg-blue-500 animate-pulse': index === currentActionIndex && status === 'running' && index !== failedActionIndex,
                                             'bg-gray-400': index !== failedActionIndex && !completedActions.includes(index) && index !== currentActionIndex
                                         }">
                                        <span x-show="index === failedActionIndex">✗</span>
                                        <span x-show="completedActions.includes(index) && index !== failedActionIndex">✓</span>
                                        <span x-show="index === currentActionIndex && status === 'running' && index !== failedActionIndex">●</span>
                                        <span x-show="index !== failedActionIndex && !completedActions.includes(index) && index !== currentActionIndex">-</span>
                                    </div>
                                </div>
                                <p class="text-sm text-gray-600" x-text="index === failedActionIndex ? 'Failed' : (completedActions.includes(index) ? 'Completed' : (index === currentActionIndex && status === 'running' ? 'Processing...' : 'Pending'))"></p>

                                <!-- Progress connector -->
                                <div x-show="index < actions.length - 1"
                                     class="absolute right-0 top-1/2 transform translate-x-4 -translate-y-1/2 w-4 h-0.5"
                                     :class="completedActions.includes(index) ? 'bg-green-500' : 'bg-gray-300'"></div>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Tabs -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                    <div class="border-b border-gray-200">
                        <nav class="-mb-px flex">
                            <button @click="activeTab = 'logs'"
                                    class="py-3 px-6 text-sm font-medium border-b-2 transition-colors"
                                    :class="activeTab === 'logs' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'">
                                Real-time Logs
                            </button>
                            <button @click="activeTab = 'output'"
                                    class="py-3 px-6 text-sm font-medium border-b-2 transition-colors"
                                    :class="activeTab === 'output' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'">
                                Execution Output
                                <span x-show="Object.keys(results).length > 0"
                                      class="ml-2 inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800"
                                      x-text="Object.keys(results).length"></span>
                            </button>
                        </nav>
                    </div>

                    <!-- Logs Tab -->
                    <div x-show="activeTab === 'logs'" class="p-6">
                        <div class="bg-gray-900 rounded-lg p-4 h-96 overflow-y-auto font-mono text-sm">
                            <div id="log-output" class="text-gray-300 whitespace-pre-wrap break-words" x-text="logOutput"></div>
                            <div x-show="status === 'running'" class="inline-block">
                                <span class="text-blue-400">█</span>
                                <span class="animate-pulse text-gray-500">_</span>
                            </div>
                        </div>
                    </div>

                    <!-- Output Tab -->
                    <div x-show="activeTab === 'output'" class="p-6">
                        <template x-if="Object.keys(results).length > 0">
                            <div class="overflow-hidden rounded-lg border border-gray-200">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Variable</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Value</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">
                                        <template x-for="(val, key) in results" :key="key">
                                            <tr class="hover:bg-gray-50 transition-colors">
                                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 font-mono" x-text="key"></td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                    <code class="px-2 py-1 bg-green-50 text-green-700 rounded" x-text="val"></code>
                                                </td>
                                            </tr>
                                        </template>
                                    </tbody>
                                </table>
                            </div>
                        </template>
                        <div x-show="Object.keys(results).length === 0" class="text-center py-12 text-gray-500">
                            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                            <p class="mt-2">No output variables yet</p>
                        </div>
                    </div>
                </div>

                <!-- Approval Alert -->
                <div x-show="showApproval" x-transition:enter="transition ease-out duration-300"
                     x-transition:enter-start="opacity-0 transform translate-y-4"
                     x-transition:enter-end="opacity-100 transform translate-y-0"
                     class="mt-6">
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6 flex items-center justify-between">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <svg class="h-8 w-8 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-.835-1.964-.835-2.732 0L2.27 16c-.77.835.19 2.5 1.73 2.5z"/>
                                </svg>
                            </div>
                            <div class="ml-4">
                                <h3 class="text-sm font-medium text-yellow-800">Approval Required</h3>
                                <p class="mt-1 text-sm text-yellow-700">This flow requires manual approval to continue execution.</p>
                            </div>
                        </div>
                        <a :href="`/view/approvals/${approvalID}`"
                           class="ml-4 inline-flex items-center px-4 py-2 bg-yellow-600 text-white text-sm font-medium rounded-md hover:bg-yellow-700 transition-colors">
                            Review Request
                            <svg class="ml-2 -mr-1 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                            </svg>
                        </a>
                    </div>
                </div>

                <!-- Error Alert -->
                <div x-show="errorMessage" x-transition:enter="transition ease-out duration-300"
                     x-transition:enter-start="opacity-0 transform translate-y-4"
                     x-transition:enter-end="opacity-100 transform translate-y-0"
                     class="mt-6">
                    <div class="bg-red-50 border border-red-200 rounded-lg p-6">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <svg class="h-5 w-5 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                            </div>
                            <div class="ml-3">
                                <h3 class="text-sm font-medium text-red-800">Error</h3>
                                <p class="mt-1 text-sm text-red-700" x-text="errorMessage"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<script>
function flowStatusComponent(logID, actions) {
    return {
        actions: actions || [],
        currentActionIndex: -1,
        logOutput: '',
        results: {},
        ws: null,
        approvalID: null,
        showApproval: false,
        status: 'running',
        flowName: '',
        startTime: new Date().toLocaleString(),
        activeTab: 'logs',
        errorMessage: null,
        failedActionIndex: -1,
        completedActions: [],

        init() {
            this.connectWebSocket();
            this.fetchExecutionSummary();

            // Auto-scroll logs
            this.$watch('logOutput', () => {
                this.$nextTick(() => {
                    const logElement = document.getElementById('log-output');
                    if (logElement) {
                        logElement.scrollTop = logElement.scrollHeight;
                    }
                });
            });
        },

        connectWebSocket() {
            this.ws = new WebSocket(`${window.location.protocol === 'https:' ? 'wss' : 'ws'}://${window.location.host}/api/v1/{{ .Page.Namespace }}/logs/${logID}`);

            this.ws.onmessage = (event) => {
                let msg = {};
                try { msg = JSON.parse(event.data); } catch {}
                this.processMessage(msg);
            };

            this.ws.onclose = (event) => {
                console.log(event);
                if (event.code === 1000) {
                    // Normal closure - execution completed successfully
                    this.status = 'completed';
                    // Mark all actions as completed
                    for (let i = 0; i < this.actions.length; i++) {
                        if (!this.completedActions.includes(i)) {
                            this.completedActions.push(i);
                        }
                    }
                } else if (event.reason) {
                    this.errorMessage = event.reason;
                    this.status = 'failed';
                    window.dispatchEvent(
                        new CustomEvent("notify", {
                            detail: { message: event.reason, type: "error" },
                        }),
                    );
                }
            };
        },

        async fetchExecutionSummary() {
            try {
                const response = await fetch(`/api/v1/{{ .Page.Namespace }}/flows/executions/${logID}`);
                const data = await response.json();

                if (response.ok) {
                    this.status = data.status === 'pending' ? 'running' : data.status;
                    this.startTime = new Date(data.started_at).toLocaleString();
                    this.flowName = data.flow_name || '';
                } else {
                    console.error('Failed to fetch execution summary:', data.error || 'Unknown error');
                    this.notifyError(data.error || 'Failed to fetch execution summary');
                }
            } catch (error) {
                console.error('Failed to fetch execution summary:', error);
                this.notifyError('Failed to fetch execution summary');
            }
        },

        processMessage(msg) {
            // Handle action changes
            if (msg.action_id) {
                const actionIndex = this.actions.findIndex(a => a.id === msg.action_id);
                if (actionIndex !== -1) {
                    // If we're switching to a different action, mark the previous one as completed
                    if (this.currentActionIndex !== -1 && this.currentActionIndex !== actionIndex) {
                        if (!this.completedActions.includes(this.currentActionIndex)) {
                            this.completedActions.push(this.currentActionIndex);
                        }
                    }
                    // Set current action
                    this.currentActionIndex = actionIndex;
                }
            }

            // Handle message types
            switch (msg.message_type) {
                case 'log':
                    this.logOutput += (msg.value || '') + '\n';
                    break;
                case 'result':
                    this.results = { ...this.results, ...(msg.results || {}) };
                    // Don't mark as completed here - wait for action_id to change
                    break;
                case 'error':
                    this.errorMessage = msg.value || "An error occurred.";
                    this.status = 'failed';
                    // Mark current action as failed
                    if (this.currentActionIndex !== -1) {
                        this.failedActionIndex = this.currentActionIndex;
                    }
                    // Don't dispatch notification here - let onclose handle it to avoid duplicates
                    break;
                case 'approval':
                    this.approvalID = msg.value;
                    this.showApproval = true;
                    this.status = 'awaiting_approval';
                    break;
                default:
                    this.logOutput += (msg.value || '') + '\n';
            }
        },

        notifyError(message) {
            window.dispatchEvent(
                new CustomEvent("notify", {
                    detail: { message, type: "error" },
                })
            );
        }
    }
}
</script>

{{ template "partials/footer" . }}
{{ end }}
