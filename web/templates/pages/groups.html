{{ define "group_management" }}
{{ template "partials/header" . }}
<div class="bg-gray-900 min-h-screen w-full">
    <div
        class="w-full max-w-7xl mx-auto px-4 sm:px-6 lg:px-8"
        x-data="groupManagement()"
        x-init="fetchGroups()"
    >
        <div class="py-10">
            <h1 class="text-2xl font-semibold text-white">Groups Management</h1>
        </div>

    <!-- Search and Add Group Section -->
    <div class="flex justify-between items-center mb-6">
        <input
            type="text"
            x-model="state.searchQuery"
            @input.debounce.500ms="fetchGroups()"
            placeholder="Search groups..."
            class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full max-w-lg p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500"
        />
        <button
            @click="openAddGroupModal()"
            class="ml-4 text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800"
        >
            Add Group
        </button>
    </div>

    <!-- Groups Table -->
    <div class="mt-8 overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-700 bg-gray-800 rounded-lg shadow">
            <thead class="bg-gray-800">
                <tr>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Name</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Description</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Users</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Actions</th>
                </tr>
            </thead>
            <tbody class="bg-gray-800 divide-y divide-gray-700">
                <template x-for="group in state.groups" :key="group.id">
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-gray-500 dark:text-gray-300" x-text="group.name"></td>
                        <td class="px-6 py-4 whitespace-nowrap text-gray-500 dark:text-gray-300" x-text="group.description || 'No description'"></td>
                        <td class="px-6 py-4 whitespace-nowrap text-gray-500 dark:text-gray-300">
                            <span x-text="group.users.length + (group.users.length === 1 ? ' user' : ' users')"></span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-gray-500 dark:text-gray-300">
                            <button class="inline-flex items-center px-3 py-1.5 text-xs font-medium text-blue-700 bg-blue-100 rounded hover:bg-blue-200 dark:bg-blue-900 dark:text-blue-200 dark:hover:bg-blue-800 mr-2" @click="editGroup(group.id)">Edit</button>
                            <button class="inline-flex items-center px-3 py-1.5 text-xs font-medium text-red-700 bg-red-100 rounded hover:bg-red-200 dark:bg-red-900 dark:text-red-200 dark:hover:bg-red-800" @click="deleteGroup(group.id)">Delete</button>
                        </td>
                    </tr>
                </template>
                <tr x-show="state.groups.length === 0">
                    <td colspan="4" class="text-center px-6 py-4 text-gray-500 dark:text-gray-400">No groups found.</td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Pagination Controls -->
    <div class="flex justify-center mt-4" x-show="state.pageCount > 1">
        <div class="join">
            <button class="join-item btn btn-sm"
                :class="{'btn-disabled': state.page === 1}"
                @click="goToPage(state.page - 1)"
                :disabled="state.page === 1"
            >Prev</button>
            <template x-for="p in state.pageCount" :key="p">
                <button class="join-item btn btn-sm"
                    :class="{'btn-active': p === state.page}"
                    @click="goToPage(p)"
                    x-text="p"
                ></button>
            </template>
            <button class="join-item btn btn-sm"
                :class="{'btn-disabled': state.page === state.pageCount}"
                @click="goToPage(state.page + 1)"
                :disabled="state.page === state.pageCount"
            >Next</button>
        </div>
    </div>

    <!-- Group Modal (reused for both add and edit) -->
    <div class="fixed inset-0 z-50 flex items-center justify-center bg-gray-900/60" x-show="modals.group">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg w-full max-w-lg p-6">
            <h3 class="font-bold text-lg mb-4 text-gray-900 dark:text-white" x-text="modals.mode === 'add' ? 'Add Group' : 'Edit Group'"></h3>
            <form @submit.prevent="submitGroup">
                <div class="mb-4">
                    <label class="block mb-1 font-medium text-gray-900 dark:text-white">Name</label>
                    <input type="text" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500" x-model="forms.group.name" required />
                </div>
                <div class="mb-4">
                    <label class="block mb-1 font-medium text-gray-900 dark:text-white">Description</label>
                    <input type="text" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500" x-model="forms.group.description" />
                </div>
                <div class="flex justify-end gap-2 mt-6">
                    <button type="button" class="inline-flex items-center px-5 py-2.5 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 dark:bg-gray-700 dark:text-gray-200 dark:hover:bg-gray-600" @click="closeGroupModal()">Cancel</button>
                    <button type="submit" class="inline-flex items-center px-5 py-2.5 text-sm font-medium text-white bg-blue-700 rounded-lg hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800" x-text="modals.mode === 'add' ? 'Add' : 'Update'"></button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    function groupManagement() {
        return {
            // State management
            state: {
                groups: [],
                searchQuery: "",
                page: 1,
                count: 10,
                pageCount: 1,
                totalCount: 0,
                loading: false,
                users: [],
                usersPage: 1,
                usersPageCount: 1,
                usersLoading: false
            },

            // Modal states
            modals: {
                group: false,
                mode: 'add',
                currentGroupId: null
            },

            // Form states
            forms: {
                group: {
                    name: "",
                    description: "",
                    selectedUsers: [],
                    userSearch: ""
                }
            },

            // Methods
            fetchGroups() {
                this.state.loading = true;
                let url = `/api/v1/groups?page=${this.state.page}&count_per_page=${this.state.count}`;
                if (this.state.searchQuery) {
                    url += `&filter=${encodeURIComponent(this.state.searchQuery)}`;
                }

                fetch(url)
                    .then(res => res.json())
                    .then(data => {
                        if (!res.ok) {
                            this.notifyError(data.error || "Failed to fetch groups");
                            this.state.groups = [];
                            this.state.pageCount = 1;
                            return;
                        }
                        this.state.groups = data.groups || [];
                        this.state.pageCount = data.page_count || 1;
                        this.state.totalCount = data.total_count || 0;
                    })
                    .catch(err => {
                        this.notifyError("Failed to fetch groups");
                        this.state.groups = [];
                        this.state.pageCount = 1;
                    })
                    .finally(() => {
                        this.state.loading = false;
                    });
            },

            fetchUsers(page = 1) {
                this.state.usersPage = page;
                this.state.usersLoading = true;

                let url = `/api/v1/users?page=${this.state.usersPage}&count_per_page=${this.state.count}`;
                if (this.forms.group.userSearch) {
                    url += `&filter=${encodeURIComponent(this.forms.group.userSearch)}`;
                }

                fetch(url)
                    .then(res => res.json())
                    .then(data => {
                        if (!res.ok) {
                            this.notifyError(data.error || "Failed to fetch users");
                            this.state.users = [];
                            this.state.usersPageCount = 1;
                            return;
                        }
                        this.state.users = data.users || [];
                        this.state.usersPageCount = data.page_count || 1;
                    })
                    .catch(err => {
                        this.notifyError("Failed to fetch users");
                        this.state.users = [];
                        this.state.usersPageCount = 1;
                    })
                    .finally(() => {
                        this.state.usersLoading = false;
                    });
            },

            getGroup(id) {
                return fetch(`/api/v1/groups/${id}`)
                    .then(res => res.json())
                    .then(data => {
                        if (!res.ok) {
                            throw new Error(data.error || "Failed to fetch group");
                        }
                        return data;
                    });
            },

            editGroup(id) {
                this.modals.mode = 'edit';
                this.modals.currentGroupId = id;
                this.modals.group = true;
                
                this.getGroup(id)
                    .then(group => {
                        this.forms.group = {
                            name: group.name,
                            description: group.description
                        };
                    })
                    .catch(err => {
                        this.notifyError("Failed to load group details");
                        this.closeGroupModal();
                    });
            },

            openAddGroupModal() {
                this.modals.mode = 'add';
                this.modals.currentGroupId = null;
                this.forms.group = {
                    name: "",
                    description: ""
                };
                this.modals.group = true;
            },

            closeGroupModal() {
                this.modals.group = false;
            },

            submitGroup() {
                const payload = {
                    name: this.forms.group.name,
                    description: this.forms.group.description
                };

                const url = this.modals.mode === 'add'
                    ? '/api/v1/groups'
                    : `/api/v1/groups/${this.modals.currentGroupId}`;

                const method = this.modals.mode === 'add' ? 'POST' : 'PUT';

                fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                })
                .then(res => res.json())
                .then(data => {
                    if (!res.ok) {
                        this.notifyError(data.error || `Failed to ${this.modals.mode} group`);
                        return;
                    }
                    this.closeGroupModal();
                    this.fetchGroups();
                    this.notifySuccess(`Group ${this.modals.mode === 'add' ? 'added' : 'updated'} successfully`);
                })
                .catch(err => {
                    this.notifyError(`Failed to ${this.modals.mode} group`);
                });
            },

            goToPage(p) {
                if (p < 1 || p > this.state.pageCount) return;
                this.state.page = p;
                this.fetchGroups();
            },

            deleteGroup(id) {
                if (confirm("Are you sure you want to delete this group?")) {
                    fetch(`/api/v1/groups/${id}`, {
                        method: 'DELETE'
                    })
                    .then(res => res.json())
                    .then(data => {
                        if (!res.ok) {
                            this.notifyError(data.error || "Failed to delete group");
                            return;
                        }
                        this.fetchGroups();
                        this.notifySuccess("Group deleted successfully");
                    })
                    .catch(err => {
                        this.notifyError("Failed to delete group");
                    });
                }
            },

            // Notification methods
            notifySuccess(message) {
                window.dispatchEvent(
                    new CustomEvent("notify", {
                        detail: { message, type: "success" },
                    })
                );
            },

            notifyError(message) {
                window.dispatchEvent(
                    new CustomEvent("notify", {
                        detail: { message, type: "error" },
                    })
                );
            }
        };
    }
</script>
{{ template "partials/footer" . }}
{{ end }}
