{{ define "history" }}
{{ template "partials/header" . }}

<div class="flex h-screen bg-gray-50">
    <!-- Sidebar -->
    {{ template "partials/sidebar" . }}

    <!-- Main Content -->
    <div x-data="historyManager()" x-init="init()" class="flex-1 flex flex-col overflow-hidden">
        <!-- Header -->
        <header class="bg-white border-b border-gray-200 px-6 py-4">
            <div class="flex items-center justify-between">
                {{ template "partials/breadcrumb" . }}

                <!-- Right side -->
                <div class="flex items-center space-x-4" @search-input="handleSearchInput($event.detail)">
                    <!-- Search -->
                    <div data-placeholder="Search executions...">
                        {{ template "partials/search_input" . }}
                    </div>

                    {{ template "partials/user_dropdown" . }}
                </div>
            </div>
        </header>

        <!-- Main Content Area -->
        <main class="flex-1 overflow-y-auto bg-gray-50 p-6" @pagination-change="goToPageFromEvent($event.detail)">
            <!-- Page Header -->
            <div class="mb-6">
                <h2 class="text-2xl font-semibold text-gray-900">Execution History</h2>
                <p class="text-gray-600 mt-1">View all flow execution history across all flows in this namespace</p>
            </div>

            <!-- Loading State -->
            <div x-show="loading" class="flex items-center justify-center h-64">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                <span class="ml-3 text-gray-600">Loading executions...</span>
            </div>

            <!-- Error Message -->
            <div x-show="errorMessage" class="mb-6 bg-red-50 border border-red-200 rounded-lg p-4">
                <div class="flex">
                    <svg class="w-5 h-5 text-red-400 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <div class="ml-3">
                        <h3 class="text-sm font-medium text-red-800">Error</h3>
                        <p class="mt-1 text-sm text-red-700" x-text="errorMessage"></p>
                    </div>
                </div>
            </div>

            <!-- Executions Table -->
            <div x-show="!loading && executions.length > 0" class="bg-white rounded-lg border border-gray-200 overflow-hidden shadow-sm">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Execution ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Triggered By</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Started At</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Duration</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <template x-for="execution in executions" :key="execution.id">
                            <tr class="hover:bg-gray-50 cursor-pointer" @click="viewExecution(execution.id)">
                                <!-- Execution ID Column -->
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="flex items-center">
                                        <div class="w-8 h-8 rounded-lg bg-gray-100 flex items-center justify-center mr-3">
                                            <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                            </svg>
                                        </div>
                                        <div>
                                            <div class="text-sm font-medium text-gray-900" x-text="execution.flow_name || 'Unknown Flow'"></div>
                                            <div class="text-xs text-gray-500 font-mono" x-text="execution.id"></div>
                                        </div>
                                    </div>
                                </td>

                                <!-- Status Column -->
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium"
                                          :class="{
                                              'bg-green-100 text-green-800': execution.status === 'completed',
                                              'bg-yellow-100 text-yellow-800': execution.status === 'pending',
                                              'bg-red-100 text-red-800': execution.status === 'errored'
                                          }">
                                        <span class="w-1.5 h-1.5 mr-1.5 rounded-full"
                                              :class="{
                                                  'bg-green-400': execution.status === 'completed',
                                                  'bg-yellow-400': execution.status === 'pending',
                                                  'bg-red-400': execution.status === 'errored'
                                              }"></span>
                                        <span x-text="capitalizeStatus(execution.status)"></span>
                                    </span>
                                </td>

                                <!-- Triggered By Column -->
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="flex items-center">
                                        <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center mr-3">
                                            <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                            </svg>
                                        </div>
                                        <span class="text-sm font-medium text-gray-900" x-text="execution.triggered_by || 'System'"></span>
                                    </div>
                                </td>

                                <!-- Started At Column -->
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                    <div>
                                        <div x-text="formatDate(execution.started_at)"></div>
                                        <div class="text-xs text-gray-500" x-text="formatTime(execution.started_at)"></div>
                                    </div>
                                </td>

                                <!-- Duration Column -->
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                    <span x-text="execution.duration || formatDuration(execution.started_at, execution.completed_at)"></span>
                                </td>

                                <!-- Actions Column -->
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                    <button @click.stop="viewExecution(execution.id)"
                                            class="text-blue-600 hover:text-blue-800 mr-3">
                                        View
                                    </button>
                                    <button @click.stop="viewLogs(execution.id)"
                                            class="text-green-600 hover:text-green-800">
                                        Logs
                                    </button>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>

            <!-- Empty State -->
            <div x-show="!loading && executions.length === 0" class="flex flex-col items-center justify-center h-64 text-center">
                <svg class="w-16 h-16 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
                </svg>
                <h3 class="text-lg font-medium text-gray-900 mb-2">No execution history</h3>
                <p class="text-gray-500 mb-4">Executions will appear here once flows are triggered.</p>
                <a href="/view/{{ .Page.Namespace }}/flows"
                   class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors">
                    Browse Flows
                </a>
            </div>

            <!-- Pagination -->
            {{ template "partials/pagination" . }}
        </main>
    </div>
</div>

<script>
function historyManager() {
    return {
        executions: [],
        searchQuery: '',
        selectedNamespace: '{{ .Page.Namespace }}',
        loading: false,
        errorMessage: '',
        page: 1,
        itemsPerPage: 20,
        totalCount: 0,
        pageCount: 0,

        init() {
            console.log('History manager initialized for namespace:', this.selectedNamespace);
            this.loadExecutions();
        },


        async loadExecutions() {
            this.loading = true;
            this.errorMessage = '';

            try {
                const url = new URL(`/api/v1/${this.selectedNamespace}/flows/executions`, window.location.origin);
                url.searchParams.append('page', this.page);
                url.searchParams.append('count', this.itemsPerPage);
                if (this.searchQuery) {
                    url.searchParams.append('filter', this.searchQuery);
                }

                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (!response.ok) {
                    this.errorMessage = data.error || 'Failed to fetch execution history';
                    this.executions = [];
                    return;
                }

                this.executions = data.executions || [];
                this.totalCount = data.total_count || 0;
                this.pageCount = data.page_count || 1;
            } catch (error) {
                console.error('Error loading executions:', error);
                this.errorMessage = 'Failed to load execution history';
                this.executions = [];
            } finally {
                this.loading = false;
            }
        },

        goToPage(p) {
            if (p < 1 || p > this.pageCount) return;
            this.page = p;
            this.loadExecutions();
        },

        goToPageFromEvent(eventDetail) {
            this.goToPage(eventDetail.page);
        },

        searchExecutions() {
            this.page = 1;
            this.loadExecutions();
        },

        handleSearchInput(eventDetail) {
            this.searchQuery = eventDetail.query;
            this.searchExecutions();
        },

        viewExecution(executionId) {
            // Navigate to execution details (if such a page exists)
            window.location.href = `/api/v1/${this.selectedNamespace}/flows/executions/${executionId}`;
        },

        viewLogs(executionId) {
            // Navigate to logs view
            const logUrl = `/view/${this.selectedNamespace}/logs/${executionId}`;
            window.open(logUrl, '_blank');
        },

        capitalizeStatus(status) {
            if (!status) return '';
            return status.charAt(0).toUpperCase() + status.slice(1);
        },

        formatDate(dateString) {
            if (!dateString) return 'Unknown';
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

            if (diffDays === 0) return 'Today';
            if (diffDays === 1) return 'Yesterday';
            if (diffDays < 7) return `${diffDays} days ago`;
            return date.toLocaleDateString();
        },

        formatTime(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        },

        formatDuration(startedAt, completedAt) {
            if (!startedAt) return 'Unknown';
            if (!completedAt) return 'Running...';

            const start = new Date(startedAt);
            const end = new Date(completedAt);
            const durationMs = end - start;

            if (durationMs < 1000) return '<1s';

            const seconds = Math.floor(durationMs / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);

            if (hours > 0) {
                return `${hours}h ${minutes % 60}m`;
            } else if (minutes > 0) {
                return `${minutes}m ${seconds % 60}s`;
            } else {
                return `${seconds}s`;
            }
        },

        notifyError(message) {
            window.dispatchEvent(
                new CustomEvent("notify", {
                    detail: { message, type: "error" },
                })
            );
        }
    };
}
</script>

{{ template "partials/footer" . }}
{{ end }}
