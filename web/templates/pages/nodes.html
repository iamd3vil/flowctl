{{ define "node_management" }}
{{ template "partials/header" . }}
<div class="bg-gray-900 min-h-screen w-full">
    <div
        class="w-full max-w-7xl mx-auto px-4 sm:px-6 lg:px-8"
        x-data="nodeManagement()"
        x-init="fetchNodes()"
    >
        <div class="py-10">
            <h1 class="text-2xl font-semibold text-white">Nodes Management</h1>
        </div>

        <!-- Search and Add Node Section -->
        <div class="flex justify-between items-center mb-6">
            <input
                type="text"
                x-model="state.searchQuery"
                @input.debounce.500ms="fetchNodes()"
                placeholder="Search nodes..."
                class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full max-w-lg p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500"
            />
            <button
                @click="openAddNodeModal()"
                class="ml-4 text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800"
            >
                Add Node
            </button>
        </div>

        <!-- Nodes Table -->
        <div class="mt-8 overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-700 bg-gray-800 rounded-lg shadow">
                <thead class="bg-gray-800">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Name</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Hostname</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Status</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Tags</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-gray-800 divide-y divide-gray-700">
                    <template x-for="node in state.nodes" :key="node.id">
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-gray-500 dark:text-gray-300" x-text="node.name"></td>
                            <td class="px-6 py-4 whitespace-nowrap text-gray-500 dark:text-gray-300" x-text="node.hostname"></td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span :class="{
                                    'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200': node.status === 'active',
                                    'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200': node.status === 'inactive',
                                    'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200': node.status === 'pending'
                                }" class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium" x-text="node.status"></span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-gray-500 dark:text-gray-300">
                                <div class="flex flex-wrap gap-1 items-center">
                                    <template x-for="tag in node.tags" :key="tag">
                                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200" x-text="tag"></span>
                                    </template>
                                    <template x-if="node.tags.length === 0">
                                        <span class="text-gray-400 dark:text-gray-500">No tags</span>
                                    </template>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-gray-500 dark:text-gray-300">
                                <button class="inline-flex items-center px-3 py-1.5 text-xs font-medium text-blue-700 bg-blue-100 rounded hover:bg-blue-200 dark:bg-blue-900 dark:text-blue-200 dark:hover:bg-blue-800 mr-2" @click="editNode(node.id)">Edit</button>
                                <button class="inline-flex items-center px-3 py-1.5 text-xs font-medium text-green-700 bg-green-100 rounded hover:bg-green-200 dark:bg-green-900 dark:text-green-200 dark:hover:bg-green-800 mr-2" @click="testConnection(node.id)">Test</button>
                                <button class="inline-flex items-center px-3 py-1.5 text-xs font-medium text-red-700 bg-red-100 rounded hover:bg-red-200 dark:bg-red-900 dark:text-red-200 dark:hover:bg-red-800" @click="deleteNode(node.id)">Delete</button>
                            </td>
                        </tr>
                    </template>
                    <tr x-show="state.nodes.length === 0">
                        <td colspan="5" class="text-center px-6 py-4 text-gray-500 dark:text-gray-400">No nodes found.</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Pagination Controls -->
        <div class="flex justify-center mt-4" x-show="state.pageCount > 1">
            <div class="join">
                <button class="join-item btn btn-sm"
                    :class="{'btn-disabled': state.page === 1}"
                    @click="goToPage(state.page - 1)"
                    :disabled="state.page === 1"
                >Prev</button>
                <template x-for="p in state.pageCount" :key="p">
                    <button class="join-item btn btn-sm"
                        :class="{'btn-active': p === state.page}"
                        @click="goToPage(p)"
                        x-text="p"
                    ></button>
                </template>
                <button class="join-item btn btn-sm"
                    :class="{'btn-disabled': state.page === state.pageCount}"
                    @click="goToPage(state.page + 1)"
                    :disabled="state.page === state.pageCount"
                >Next</button>
            </div>
        </div>

        <!-- Node Modal -->
        <div class="fixed inset-0 z-50 flex items-center justify-center bg-gray-900/60" x-show="modals.node">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg w-full max-w-lg p-6">
                <h3 class="font-bold text-lg mb-4 text-gray-900 dark:text-white" x-text="modals.mode === 'add' ? 'Add Node' : 'Edit Node'"></h3>
                <form @submit.prevent="submitNode">
                    <div class="mb-4">
                        <label class="block mb-1 font-medium text-gray-900 dark:text-white">Name</label>
                        <input type="text" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500" x-model="forms.node.name" required />
                    </div>
                    <div class="mb-4">
                        <label class="block mb-1 font-medium text-gray-900 dark:text-white">Hostname</label>
                        <input type="text" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500" x-model="forms.node.hostname" required />
                    </div>
                    <div class="mb-4">
                        <label class="block mb-1 font-medium text-gray-900 dark:text-white">Port</label>
                        <input type="number" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500" x-model="forms.node.port" value="22" />
                    </div>
                    <div class="mb-4">
                        <label class="block mb-1 font-medium text-gray-900 dark:text-white">Username</label>
                        <input type="text" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500" x-model="forms.node.username" />
                    </div>
                    <div class="mb-4">
                        <label class="block mb-1 font-medium text-gray-900 dark:text-white">Credentials</label>
                        <select class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500" x-model="forms.node.credential_id">
                            <option value="">Select credential</option>
                            <template x-for="credential in state.credentials" :key="credential.id">
                                <option :value="credential.id" x-text="credential.name"></option>
                            </template>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label class="block mb-1 font-medium text-gray-900 dark:text-white">Tags (comma-separated)</label>
                        <input type="text" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500" x-model="forms.node.tags" placeholder="production,web,east" />
                    </div>
                    <div class="mb-4">
                        <label class="block mb-1 font-medium text-gray-900 dark:text-white">Description</label>
                        <textarea class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500" x-model="forms.node.description" rows="3"></textarea>
                    </div>
                    <div class="flex justify-end gap-2 mt-6">
                        <button type="button" class="inline-flex items-center px-5 py-2.5 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 dark:bg-gray-700 dark:text-gray-200 dark:hover:bg-gray-600" @click="closeNodeModal()">Cancel</button>
                        <button type="submit" class="inline-flex items-center px-5 py-2.5 text-sm font-medium text-white bg-blue-700 rounded-lg hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800" x-text="modals.mode === 'add' ? 'Add' : 'Update'"></button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    function nodeManagement() {
        return {
            state: {
                nodes: [],
                credentials: [],
                searchQuery: "",
                page: 1,
                count: 10,
                pageCount: 1,
                totalCount: 0,
                loading: false
            },

            modals: {
                node: false,
                mode: 'add',
                currentNodeId: null
            },

            forms: {
                node: {
                    name: "",
                    hostname: "",
                    port: 22,
                    username: "",
                    credential_id: "",
                    tags: "",
                    description: ""
                }
            },

            fetchNodes() {
                this.state.loading = true;
                let url = `/api/v1/{{ .Page.Namespace }}/nodes?page=${this.state.page}&count_per_page=${this.state.count}`;
                if (this.state.searchQuery) {
                    url += `&filter=${encodeURIComponent(this.state.searchQuery)}`;
                }

                fetch(url)
                    .then(res => res.json())
                    .then(data => {
                        // Ensure data.nodes is an array before calling map
                        const nodes = Array.isArray(data.nodes) ? data.nodes : [];
                        this.state.nodes = nodes.map(node => ({
                            ...node,
                            tags: Array.isArray(node.tags) ? node.tags : [],
                            status: 'active'
                        }));
                        this.state.pageCount = data.page_count || 1;
                        this.state.totalCount = data.total_count || 0;
                    })
                    .catch(err => {
                        this.notifyError(err.message || "Failed to fetch nodes");
                        this.state.nodes = [];
                        this.state.pageCount = 1;
                    })
                    .finally(() => {
                        this.state.loading = false;
                    });
            },

            fetchCredentials() {
                fetch('/api/v1/{{ .Page.Namespace }}/credentials')
                    .then(res => res.json())
                    .then(data => {
                        // Handle both possible response structures
                        const credentials = Array.isArray(data.credentials) ? data.credentials : 
                                          Array.isArray(data) ? data : [];
                        this.state.credentials = credentials.map(cred => ({
                            ...cred,
                            type: cred.private_key ? 'ssh_key' : 'password'
                        }));
                    })
                    .catch(err => {
                        this.notifyError(err.message || "Failed to fetch credentials");
                        this.state.credentials = [];
                    });
            },

            openAddNodeModal() {
                this.modals.mode = 'add';
                this.modals.currentNodeId = null;
                this.forms.node = {
                    name: "",
                    hostname: "",
                    port: 22,
                    username: "",
                    credential_id: "",
                    tags: "",
                    description: ""
                };
                this.modals.node = true;
                this.fetchCredentials();
            },

            getNode(id) {
                return fetch(`/api/v1/{{ .Page.Namespace }}/nodes/${id}`)
                    .then(res => {
                        if (!res.ok) throw new Error("Failed to fetch node");
                        return res.json();
                    });
            },

            editNode(id) {
                this.modals.mode = 'edit';
                this.modals.currentNodeId = id;
                this.modals.node = true;
                
                this.getNode(id)
                    .then(node => {
                        this.forms.node = {
                            name: node.name,
                            hostname: node.hostname,
                            port: node.port || 22,
                            username: node.username || "",
                            credential_id: node.auth?.credential_id || "",
                            tags: Array.isArray(node.tags) ? node.tags.join(', ') : "",
                            description: node.description || ""
                        };
                        this.fetchCredentials();
                    })
                    .catch(err => {
                        this.notifyError(err.message || "Failed to load node details");
                        this.closeNodeModal();
                    });
            },

            closeNodeModal() {
                this.modals.node = false;
            },

            submitNode() {
                const selectedCredential = this.state.credentials.find(c => c.id === this.forms.node.credential_id);
                const authMethod = selectedCredential ? (selectedCredential.private_key ? 'ssh_key' : 'password') : 'ssh_key';
                
                const payload = {
                    name: this.forms.node.name,
                    hostname: this.forms.node.hostname,
                    port: parseInt(this.forms.node.port),
                    username: this.forms.node.username,
                    os_family: "linux",
                    tags: this.forms.node.tags ? this.forms.node.tags.split(',').map(t => t.trim()).filter(t => t) : [],
                    auth: {
                        method: authMethod,
                        credential_id: this.forms.node.credential_id
                    }
                };

                const url = this.modals.mode === 'add'
                    ? '/api/v1/{{ .Page.Namespace }}/nodes'
                    : `/api/v1/{{ .Page.Namespace }}/nodes/${this.modals.currentNodeId}`;

                const method = this.modals.mode === 'add' ? 'POST' : 'PUT';

                fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                })
                .then(res => {
                    if (!res.ok) throw new Error(`Failed to ${this.modals.mode} node`);
                    return res.json();
                })
                .then(() => {
                    this.closeNodeModal();
                    this.fetchNodes();
                    this.notifySuccess(`Node ${this.modals.mode === 'add' ? 'added' : 'updated'} successfully`);
                })
                .catch(err => {
                    this.notifyError(err.message || `Failed to ${this.modals.mode} node`);
                });
            },

            testConnection(id) {
                fetch(`/api/v1/{{ .Page.Namespace }}/nodes/${id}/test`, {
                    method: 'POST'
                })
                .then(res => {
                    if (!res.ok) throw new Error("Connection test failed");
                    return res.json();
                })
                .then(data => {
                    this.notifySuccess(data.message || "Connection test successful");
                })
                .catch(err => {
                    this.notifyError(err.message || "Connection test failed");
                });
            },

            deleteNode(id) {
                if (confirm("Are you sure you want to delete this node?")) {
                    fetch(`/api/v1/{{ .Page.Namespace }}/nodes/${id}`, {
                        method: 'DELETE'
                    })
                    .then(res => {
                        if (!res.ok) throw new Error("Failed to delete node");
                    })
                    .then(() => {
                        this.fetchNodes();
                        this.notifySuccess("Node deleted successfully");
                    })
                    .catch(err => {
                        this.notifyError(err.message || "Failed to delete node");
                    });
                }
            },

            goToPage(p) {
                if (p < 1 || p > this.state.pageCount) return;
                this.state.page = p;
                this.fetchNodes();
            },

            notifySuccess(message) {
                window.dispatchEvent(
                    new CustomEvent("notify", {
                        detail: { message, type: "success" },
                    })
                );
            },

            notifyError(message) {
                window.dispatchEvent(
                    new CustomEvent("notify", {
                        detail: { message, type: "error" },
                    })
                );
            }
        };
    }
</script>
{{ template "partials/footer" . }}
{{ end }}