{{ define "nodes_test" }}
{{ template "partials/header" . }}

<div class="flex h-screen bg-gray-50">
    <!-- Sidebar -->
    {{ template "partials/sidebar" . }}

    <!-- Main Content -->
    <div x-data="nodesManager()" x-init="init()" class="flex-1 flex flex-col overflow-hidden">
        <!-- Header -->
        <header class="bg-white border-b border-gray-200 px-6 py-4">
            <div class="flex items-center justify-between">
                <!-- Breadcrumb -->
                <nav class="flex items-center space-x-2 text-sm">
                    <span class="text-gray-500">Namespaces</span>
                    <span class="text-gray-400">/</span>
                    <span class="text-gray-500">{{ .Page.Namespace }}</span>
                    <span class="text-gray-400">/</span>
                    <span class="text-gray-900 font-medium">Nodes</span>
                </nav>

                <!-- Actions -->
                <div class="flex items-center space-x-4">
                    <!-- Search -->
                    <div class="relative">
                        <svg class="w-5 h-5 absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                        <input type="text"
                               placeholder="Search nodes..."
                               x-model="searchQuery"
                               @input.debounce.300ms="searchNodes()"
                               class="pl-10 pr-4 py-2 w-80 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <!-- Add Node Button -->
                    <button @click="openAddNodeModal()"
                            class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors">
                        <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                        Add Node
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content Area -->
        <main class="flex-1 overflow-y-auto bg-gray-50 p-6">
            <!-- Statistics Cards -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <!-- Total Nodes -->
                <div class="bg-white rounded-lg border border-gray-200 p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600">Total Nodes</p>
                            <p class="text-2xl font-bold text-gray-900" x-text="totalCount"></p>
                        </div>
                        <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                            <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01"></path>
                            </svg>
                        </div>
                    </div>
                </div>

                <!-- Linux Nodes -->
                <div class="bg-white rounded-lg border border-gray-200 p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600">Linux Nodes</p>
                            <p class="text-2xl font-bold text-gray-900" x-text="linuxCount"></p>
                        </div>
                        <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                            <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"></path>
                            </svg>
                        </div>
                    </div>
                </div>

                <!-- Windows Nodes -->
                <div class="bg-white rounded-lg border border-gray-200 p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600">Windows Nodes</p>
                            <p class="text-2xl font-bold text-gray-900" x-text="windowsCount"></p>
                        </div>
                        <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                            <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 002-2M9 7a2 2 0 012-2h2a2 2 0 012 2m0 10V7m0 10a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 00-2-2h-2a2 2 0 00-2 2"></path>
                            </svg>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Loading State -->
            <div x-show="loading" class="flex items-center justify-center h-64">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
            </div>

            <!-- Nodes Table -->
            <div x-show="!loading && nodes.length > 0" class="bg-white rounded-lg border border-gray-200 overflow-hidden">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Node</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Hostname</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Port</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Username</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">OS Family</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tags</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <template x-for="node in nodes" :key="node.id">
                            <tr class="hover:bg-gray-50">
                                <!-- Node Column -->
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="flex items-center">
                                        <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center mr-3">
                                            <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01"></path>
                                            </svg>
                                        </div>
                                        <div>
                                            <div class="text-sm font-medium text-gray-900" x-text="node.name"></div>
                                            <div class="text-sm text-gray-500" x-text="node.id"></div>
                                        </div>
                                    </div>
                                </td>

                                <!-- Hostname Column -->
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="node.hostname"></td>

                                <!-- Port Column -->
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="node.port"></td>

                                <!-- Username Column -->
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="node.username"></td>

                                <!-- OS Family Column -->
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium"
                                          :class="{ 'bg-green-100 text-green-800': node.os_family === 'linux', 'bg-blue-100 text-blue-800': node.os_family === 'windows' }"
                                          x-text="node.os_family"></span>
                                </td>

                                <!-- Tags Column -->
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="flex flex-wrap gap-1">
                                        <template x-for="tag in node.tags" :key="tag">
                                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800" x-text="tag"></span>
                                        </template>
                                        <template x-if="!node.tags || node.tags.length === 0">
                                            <span class="text-xs text-gray-400">No tags</span>
                                        </template>
                                    </div>
                                </td>

                                <!-- Actions Column -->
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                    <div class="flex space-x-2">
                                        <button @click="editNode(node.id)" class="text-blue-600 hover:text-blue-800">Edit</button>
                                        <button @click="deleteNode(node.id)" class="text-red-600 hover:text-red-800">Delete</button>
                                    </div>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>

            <!-- Empty State -->
            <div x-show="!loading && nodes.length === 0" class="flex flex-col items-center justify-center h-64 text-center">
                <svg class="w-16 h-16 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01"></path>
                </svg>
                <h3 class="text-lg font-medium text-gray-900 mb-2">No nodes found</h3>
                <p class="text-gray-500 mb-4">Get started by adding your first node.</p>
                <button @click="openAddNodeModal()"
                        class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors">
                    Add Node
                </button>
            </div>

            <!-- Pagination -->
            <div x-show="!loading && pageCount > 1" class="flex justify-center mt-8">
                <nav class="flex items-center space-x-2">
                    <button @click="goToPage(page - 1)"
                            :disabled="page === 1"
                            :class="{ 'opacity-50 cursor-not-allowed': page === 1 }"
                            class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">
                        Previous
                    </button>

                    <template x-for="p in Array.from({length: pageCount}, (_, i) => i + 1)" :key="p">
                        <button @click="goToPage(p)"
                                :class="{ 'bg-blue-600 text-white': p === page, 'bg-white text-gray-700': p !== page }"
                                class="px-3 py-2 text-sm font-medium border border-gray-300 rounded-lg hover:bg-gray-50"
                                x-text="p">
                        </button>
                    </template>

                    <button @click="goToPage(page + 1)"
                            :disabled="page === pageCount"
                            :class="{ 'opacity-50 cursor-not-allowed': page === pageCount }"
                            class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">
                        Next
                    </button>
                </nav>
            </div>
        </main>

    <!-- Add/Edit Node Modal -->
    <div class="fixed inset-0 z-50 flex items-center justify-center bg-gray-900/60" x-show="showModal">
        <div class="bg-white rounded-lg shadow-lg w-full max-w-lg p-6">
            <h3 class="font-bold text-lg mb-4 text-gray-900" x-text="isEditMode ? 'Edit Node' : 'Add Node'"></h3>
            <form @submit.prevent="submitNode()">
                <div class="mb-4">
                    <label class="block mb-1 font-medium text-gray-900">Name</label>
                    <input type="text" 
                           class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" 
                           x-model="nodeForm.name" 
                           required />
                </div>
                <div class="mb-4">
                    <label class="block mb-1 font-medium text-gray-900">Hostname</label>
                    <input type="text" 
                           class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" 
                           x-model="nodeForm.hostname" 
                           required />
                </div>
                <div class="mb-4">
                    <label class="block mb-1 font-medium text-gray-900">Port</label>
                    <input type="number" 
                           class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" 
                           x-model="nodeForm.port" 
                           min="1" 
                           max="65535" 
                           required />
                </div>
                <div class="mb-4">
                    <label class="block mb-1 font-medium text-gray-900">Username</label>
                    <input type="text" 
                           class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" 
                           x-model="nodeForm.username" 
                           required />
                </div>
                <div class="mb-4">
                    <label class="block mb-1 font-medium text-gray-900">OS Family</label>
                    <select class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" 
                            x-model="nodeForm.os_family" 
                            required>
                        <option value="">Select OS</option>
                        <option value="linux">Linux</option>
                        <option value="windows">Windows</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label class="block mb-1 font-medium text-gray-900">Connection Type</label>
                    <select class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" 
                            x-model="nodeForm.connection_type" 
                            required>
                        <option value="">Select connection type</option>
                        <option value="ssh">SSH</option>
                        <option value="qssh">QSSH</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label class="block mb-1 font-medium text-gray-900">Credential</label>
                    <select class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" 
                            x-model="nodeForm.auth.credential_id" 
                            @change="onCredentialChange()"
                            required>
                        <option value="">Select credential</option>
                        <template x-for="credential in credentials" :key="credential.id">
                            <option :value="credential.id" x-text="`${credential.name} (${credential.key_type})`"></option>
                        </template>
                    </select>
                </div>
                <div class="mb-4" x-show="nodeForm.auth.method">
                    <label class="block mb-1 font-medium text-gray-900">Auth Method</label>
                    <input type="text" 
                           class="bg-gray-100 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2.5" 
                           :value="getAuthMethodDisplay(nodeForm.auth.method)"
                           readonly />
                </div>
                <div class="mb-4">
                    <label class="block mb-1 font-medium text-gray-900">Tags (comma-separated)</label>
                    <input type="text" 
                           class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" 
                           x-model="nodeForm.tagsString" 
                           placeholder="production, web, east" />
                </div>
                <div class="flex justify-end gap-2 mt-6">
                    <button type="button" 
                            class="inline-flex items-center px-5 py-2.5 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200" 
                            @click="closeNodeModal()">
                        Cancel
                    </button>
                    <button type="submit" 
                            class="inline-flex items-center px-5 py-2.5 text-sm font-medium text-white bg-blue-700 rounded-lg hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300" 
                            x-text="isEditMode ? 'Update' : 'Create'">
                    </button>
                </div>
            </form>
        </div>
    </div>
    </div>
</div>

<script>
function nodesManager() {
    return {
        nodes: [],
        credentials: [],
        searchQuery: '',
        loading: false,
        page: 1,
        pageCount: 1,
        totalCount: 0,
        showModal: false,
        isEditMode: false,
        editingNodeId: null,
        nodeForm: {
            name: '',
            hostname: '',
            port: 22,
            username: '',
            os_family: '',
            connection_type: 'ssh',
            auth: {
                credential_id: '',
                method: ''
            },
            tags: [],
            tagsString: ''
        },

        get linuxCount() {
            return this.nodes.filter(node => node.os_family === 'linux').length;
        },

        get windowsCount() {
            return this.nodes.filter(node => node.os_family === 'windows').length;
        },


        init() {
            this.fetchNodes();
            this.fetchCredentials();
        },

        async fetchNodes() {
            this.loading = true;
            try {
                let url = `/api/v1/{{ .Page.Namespace }}/nodes?page=${this.page}&count_per_page=12`;
                if (this.searchQuery) {
                    url += `&filter=${encodeURIComponent(this.searchQuery)}`;
                }

                const response = await fetch(url);
                const data = await response.json();
                
                if (!response.ok) {
                    this.notifyError(data.error || 'Failed to fetch nodes');
                    this.nodes = [];
                    return;
                }

                this.nodes = data.nodes || [];
                this.pageCount = data.page_count || 1;
                this.totalCount = data.total_count || 0;
            } catch (error) {
                console.error('Failed to fetch nodes:', error);
                this.notifyError('Failed to fetch nodes');
                this.nodes = [];
            } finally {
                this.loading = false;
            }
        },

        async fetchCredentials() {
            try {
                const response = await fetch(`/api/v1/{{ .Page.Namespace }}/credentials`);
                const data = await response.json();
                
                if (!response.ok) {
                    this.notifyError(data.error || 'Failed to fetch credentials');
                    this.credentials = [];
                    return;
                }
                
                this.credentials = data.credentials || [];
            } catch (error) {
                console.error('Failed to fetch credentials:', error);
                this.notifyError('Failed to fetch credentials');
                this.credentials = [];
            }
        },

        searchNodes() {
            this.page = 1;
            this.fetchNodes();
        },

        goToPage(p) {
            if (p >= 1 && p <= this.pageCount) {
                this.page = p;
                this.fetchNodes();
            }
        },

        openAddNodeModal() {
            this.isEditMode = false;
            this.editingNodeId = null;
            this.resetForm();
            this.showModal = true;
        },

        async editNode(nodeId) {
            this.isEditMode = true;
            this.editingNodeId = nodeId;

            try {
                const response = await fetch(`/api/v1/{{ .Page.Namespace }}/nodes/${nodeId}`);
                const node = await response.json();
                
                if (!response.ok) {
                    this.notifyError(node.error || 'Failed to load node details');
                    return;
                }

                this.nodeForm = {
                    name: node.name || '',
                    hostname: node.hostname || '',
                    port: node.port || 22,
                    username: node.username || '',
                    os_family: node.os_family || '',
                    connection_type: node.connection_type || 'ssh',
                    auth: {
                        credential_id: node.auth?.credential_id || '',
                        method: node.auth?.method || ''
                    },
                    tags: node.tags || [],
                    tagsString: (node.tags || []).join(', ')
                };

                // Update method based on selected credential
                this.onCredentialChange();

                this.showModal = true;
            } catch (error) {
                console.error('Failed to load node:', error);
                this.notifyError('Failed to load node details');
            }
        },

        async submitNode() {
            const tags = this.nodeForm.tagsString
                .split(',')
                .map(tag => tag.trim())
                .filter(tag => tag.length > 0);

            const payload = {
                name: this.nodeForm.name,
                hostname: this.nodeForm.hostname,
                port: parseInt(this.nodeForm.port),
                username: this.nodeForm.username,
                os_family: this.nodeForm.os_family,
                connection_type: this.nodeForm.connection_type,
                tags: tags,
                auth: {
                    credential_id: this.nodeForm.auth.credential_id,
                    method: this.nodeForm.auth.method
                }
            };

            try {
                const url = this.isEditMode
                    ? `/api/v1/{{ .Page.Namespace }}/nodes/${this.editingNodeId}`
                    : `/api/v1/{{ .Page.Namespace }}/nodes`;

                const method = this.isEditMode ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();
                
                if (response.ok) {
                    this.closeNodeModal();
                    this.fetchNodes();
                    this.notifySuccess(`Node ${this.isEditMode ? 'updated' : 'created'} successfully`);
                } else {
                    console.error('Failed to save node');
                    this.notifyError(data.error || 'Failed to save node');
                }
            } catch (error) {
                console.error('Error saving node:', error);
                this.notifyError('Error saving node');
            }
        },

        async deleteNode(nodeId) {
            if (confirm('Are you sure you want to delete this node?')) {
                try {
                    const response = await fetch(`/api/v1/{{ .Page.Namespace }}/nodes/${nodeId}`, {
                        method: 'DELETE'
                    });

                    const data = await response.json();
                    
                    if (response.ok) {
                        this.fetchNodes();
                        this.notifySuccess('Node deleted successfully');
                    } else {
                        console.error('Failed to delete node');
                        this.notifyError(data.error || 'Failed to delete node');
                    }
                } catch (error) {
                    console.error('Error deleting node:', error);
                    this.notifyError('Error deleting node');
                }
            }
        },


        closeNodeModal() {
            this.showModal = false;
            this.resetForm();
        },

        resetForm() {
            this.nodeForm = {
                name: '',
                hostname: '',
                port: 22,
                username: '',
                os_family: '',
                connection_type: 'ssh',
                auth: {
                    credential_id: '',
                    method: ''
                },
                tags: [],
                tagsString: ''
            };
        },

        onCredentialChange() {
            if (this.nodeForm.auth.credential_id) {
                const selectedCredential = this.credentials.find(c => c.id === this.nodeForm.auth.credential_id);
                if (selectedCredential) {
                    this.nodeForm.auth.method = selectedCredential.key_type;
                }
            } else {
                this.nodeForm.auth.method = '';
            }
        },

        getAuthMethodDisplay(method) {
            switch (method) {
                case 'private_key':
                    return 'SSH Key';
                case 'password':
                    return 'Password';
                default:
                    return '';
            }
        },

        // Notification methods
        notifySuccess(message) {
            window.dispatchEvent(
                new CustomEvent("notify", {
                    detail: { message, type: "success" },
                })
            );
        },

        notifyError(message) {
            window.dispatchEvent(
                new CustomEvent("notify", {
                    detail: { message, type: "error" },
                })
            );
        }
    };
}
</script>

{{ template "partials/footer" . }}
{{ end }}
