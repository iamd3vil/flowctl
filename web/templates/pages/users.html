{{ define "user_management" }}
{{ template "partials/header" . }}
<div
    class="w-full max-w-7xl mx-auto px-4 sm:px-6 lg:px-8"
    x-data="userManagement()"
    x-init="fetchUsers()"
>
    <div class="py-10">
        <h1 class="text-2xl font-semibold text-foreground">Users Management</h1>
    </div>

    <!-- Search and Add User Section -->
    <div class="flex justify-between items-center mb-6">
        <input
            type="text"
            x-model="state.searchQuery"
            @input.debounce.500ms="fetchUsers()"
            placeholder="Search users..."
            class="input input-bordered w-full max-w-lg"
        />
        <button
            @click="openAddUserModal()"
            class="ml-4 btn btn-primary"
        >
            Add User
        </button>
    </div>

    <!-- Users Table -->
    <div class="mt-8 overflow-x-auto">
        <table class="table table-zebra w-full">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Username</th>
                    <th>Groups</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <template x-for="user in state.users" :key="user.id">
                    <tr>
                        <td x-text="user.name"></td>
                        <td x-text="user.username"></td>
                        <td>
                            <div class="flex flex-wrap gap-1 items-center">
                                <template x-for="(group, index) in user.groups.slice(0, 3)" :key="group.id">
                                    <span class="badge badge-primary" x-text="group.name"></span>
                                </template>
                                <template x-if="user.groups.length > 3">
                                    <div x-data="{ expanded: false }" class="relative">
                                        <button
                                            @click="expanded = !expanded"
                                            class="badge badge-ghost cursor-pointer"
                                            x-text="'+' + (user.groups.length - 3)"
                                        ></button>
                                        <div
                                            x-show="expanded"
                                            @click.outside="expanded = false"
                                            class="absolute z-10 mt-1 p-2 bg-white shadow-lg rounded-md border border-gray-200"
                                        >
                                            <div class="flex flex-wrap gap-1">
                                                <template x-for="group in user.groups.slice(3)" :key="group.id">
                                                    <span class="badge badge-primary" x-text="group.name"></span>
                                                </template>
                                            </div>
                                        </div>
                                    </div>
                                </template>
                                <template x-if="user.groups.length === 0">
                                    <span class="text-gray-400">No groups</span>
                                </template>
                            </div>
                        </td>
                        <td>
                            <button class="btn btn-xs btn-outline btn-info mr-2" @click="editUser(user.id)">Edit</button>
                            <button class="btn btn-xs btn-outline btn-error" @click="deleteUser(user.id)">Delete</button>
                        </td>
                    </tr>
                </template>
                <tr x-show="state.users.length === 0">
                    <td colspan="4" class="text-center">No users found.</td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Pagination Controls -->
    <div class="flex justify-center mt-4" x-show="state.pageCount > 1">
        <div class="join">
            <button class="join-item btn btn-sm"
                :class="{'btn-disabled': state.page === 1}"
                @click="goToPage(state.page - 1)"
                :disabled="state.page === 1"
            >Prev</button>
            <template x-for="p in state.pageCount" :key="p">
                <button class="join-item btn btn-sm"
                    :class="{'btn-active': p === state.page}"
                    @click="goToPage(p)"
                    x-text="p"
                ></button>
            </template>
            <button class="join-item btn btn-sm"
                :class="{'btn-disabled': state.page === state.pageCount}"
                @click="goToPage(state.page + 1)"
                :disabled="state.page === state.pageCount"
            >Next</button>
        </div>
    </div>

    <!-- User Modal (reused for both add and edit) -->
    <div class="modal" :class="{'modal-open': modals.user}">
        <div class="modal-box w-full max-w-lg">
            <h3 class="font-bold text-lg mb-4" x-text="modals.mode === 'add' ? 'Add User' : 'Edit User'"></h3>
            <form @submit.prevent="submitUser">
                <div class="mb-4">
                    <label class="block mb-1 font-medium">Name</label>
                    <input type="text" class="input input-bordered w-full" x-model="forms.user.name" required />
                </div>
                <div class="mb-4">
                    <label class="block mb-1 font-medium">Username</label>
                    <input type="text" class="input input-bordered w-full" x-model="forms.user.username" required />
                </div>
                <div class="mb-4">
                    <label class="block mb-1 font-medium">Groups</label>
                    <div class="dropdown" x-data="{ open: false }">
                        <button type="button" @click="open = !open" class="input input-bordered w-full flex items-center justify-between">
                            <span x-text="forms.user.selectedGroups.length ? forms.user.selectedGroups.map(g => g.name).join(', ') : 'Select groups'"></span>
                            <svg class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                            </svg>
                        </button>
                        <div x-show="open" @click.away="open = false" class="dropdown-content mt-2 w-full p-2 shadow-lg bg-base-100 rounded-box">
                            <input
                                x-model="forms.user.groupSearch"
                                @input.debounce.500ms="fetchGroups(1)"
                                class="input input-bordered w-full mb-2"
                                placeholder="Search groups..."
                            />
                            <template x-for="group in state.groups" :key="group.id">
                                <label class="flex items-center p-2 hover:bg-base-200 rounded cursor-pointer">
                                    <input
                                        type="checkbox"
                                        class="checkbox mr-2"
                                        :checked="forms.user.selectedGroups.some(g => g.id === group.id)"
                                        @change="toggleGroupSelection(group)"
                                    />
                                    <span x-text="group.name"></span>
                                </label>
                            </template>
                            <div class="flex justify-center mt-2" x-show="state.groupsPageCount > 1">
                                <button class="btn btn-xs" :disabled="state.groupsPage === 1" @click="fetchGroups(state.groupsPage - 1)">Prev</button>
                                <button class="btn btn-xs ml-2" :disabled="state.groupsPage === state.groupsPageCount" @click="fetchGroups(state.groupsPage + 1)">Next</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-action">
                    <button type="button" class="btn" @click="closeUserModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary" x-text="modals.mode === 'add' ? 'Add' : 'Update'"></button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    function userManagement() {
        return {
            // State management
            state: {
                users: [],
                searchQuery: "",
                page: 1,
                count: 10,
                pageCount: 1,
                totalCount: 0,
                loading: false,
                groups: [],
                groupsPage: 1,
                groupsPageCount: 1,
                groupsLoading: false
            },

            // Modal states
            modals: {
                user: false,
                mode: 'add',
                currentUserId: null
            },

            // Form states
            forms: {
                user: {
                    name: "",
                    username: "",
                    selectedGroups: [],
                    groupSearch: ""
                }
            },

            // Methods
            fetchUsers() {
                this.state.loading = true;
                let url = `/api/v1/users?page=${this.state.page}&count_per_page=${this.state.count}`;
                if (this.state.searchQuery) {
                    url += `&filter=${encodeURIComponent(this.state.searchQuery)}`;
                }

                fetch(url)
                    .then(res => res.json())
                    .then(data => {
                        this.state.users = data.users || [];
                        this.state.pageCount = data.page_count || 1;
                        this.state.totalCount = data.total_count || 0;
                    })
                    .catch(err => {
                        this.notifyError(err.message || "Failed to fetch users");
                        this.state.users = [];
                        this.state.pageCount = 1;
                    })
                    .finally(() => {
                        this.state.loading = false;
                    });
            },

            fetchGroups(page = 1) {
                this.state.groupsPage = page;
                this.state.groupsLoading = true;

                let url = `/api/v1/groups?page=${this.state.groupsPage}&count_per_page=${this.state.count}`;
                if (this.forms.user.groupSearch) {
                    url += `&filter=${encodeURIComponent(this.forms.user.groupSearch)}`;
                }

                fetch(url)
                    .then(res => res.json())
                    .then(data => {
                        this.state.groups = data.groups || [];
                        this.state.groupsPageCount = data.page_count || 1;
                    })
                    .catch(err => {
                        this.notifyError(err.message || "Failed to fetch groups");
                        this.state.groups = [];
                        this.state.groupsPageCount = 1;
                    })
                    .finally(() => {
                        this.state.groupsLoading = false;
                    });
            },

            openAddUserModal() {
                this.modals.mode = 'add';
                this.modals.currentUserId = null;
                this.forms.user = {
                    name: "",
                    username: "",
                    selectedGroups: [],
                    groupSearch: ""
                };
                this.modals.user = true;
                this.fetchGroups();
            },

        getUser(id) {
            return fetch(`/api/v1/users/${id}`)
                .then(res => {
                    if (!res.ok) throw new Error("Failed to fetch user");
                    return res.json();
                });
        },

        editUser(id) {
            this.modals.mode = 'edit';
            this.modals.currentUserId = id;
            this.modals.user = true;
            
            this.getUser(id)
                .then(user => {
                    this.forms.user = {
                        name: user.name,
                        username: user.username,
                        selectedGroups: [...user.groups],
                        groupSearch: ""
                    };
                    this.fetchGroups();
                })
                .catch(err => {
                    this.notifyError(err.message || "Failed to load user details");
                    this.closeUserModal();
                });
        },

            closeUserModal() {
                this.modals.user = false;
            },

            toggleGroupSelection(group) {
                const index = this.forms.user.selectedGroups.findIndex(g => g.id === group.id);
                if (index >= 0) {
                    this.forms.user.selectedGroups.splice(index, 1);
                } else {
                    this.forms.user.selectedGroups.push(group);
                }
            },

            submitUser() {
                const payload = {
                    name: this.forms.user.name,
                    username: this.forms.user.username,
                    groups: this.forms.user.selectedGroups.map(g => g.id)
                };

                // Debug log to verify payload
                console.log('Submitting user with payload:', payload);

                const url = this.modals.mode === 'add'
                    ? '/api/v1/users'
                    : `/api/v1/users/${this.modals.currentUserId}`;

                const method = this.modals.mode === 'add' ? 'POST' : 'PUT';

                fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                })
                .then(res => {
                    if (!res.ok) throw new Error(`Failed to ${this.modals.mode} user`);
                    return res.json();
                })
                .then(() => {
                    this.closeUserModal();
                    this.fetchUsers();
                    this.notifySuccess(`User ${this.modals.mode === 'add' ? 'added' : 'updated'} successfully`);
                })
                .catch(err => {
                    this.notifyError(err.message || `Failed to ${this.modals.mode} user`);
                });
            },

            goToPage(p) {
                if (p < 1 || p > this.state.pageCount) return;
                this.state.page = p;
                this.fetchUsers();
            },

            deleteUser(id) {
                if (confirm("Are you sure you want to delete this user?")) {
                    fetch(`/api/v1/users/${id}`, {
                        method: 'DELETE'
                    })
                    .then(res => {
                        if (!res.ok) throw new Error("Failed to delete user");
                        return res.json();
                    })
                    .then(() => {
                        this.fetchUsers();
                        this.notifySuccess("User deleted successfully");
                    })
                    .catch(err => {
                        this.notifyError(err.message || "Failed to delete user");
                    });
                }
            },

            // Notification methods
            notifySuccess(message) {
                window.dispatchEvent(
                    new CustomEvent("notify", {
                        detail: { message, type: "success" },
                    })
                );
            },

            notifyError(message) {
                window.dispatchEvent(
                    new CustomEvent("notify", {
                        detail: { message, type: "error" },
                    })
                );
            }
        };
    }
</script>
{{ template "partials/footer" . }}
{{ end }}
