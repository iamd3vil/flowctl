{{ define "partials/sidebar" }}
<!-- Sidebar Navigation -->
<div class="w-60 bg-slate-800 flex flex-col" x-data="sidebarManager()">
    <!-- Logo -->
    <div class="flex items-center px-6 py-6">
        <div class="w-8 h-8 bg-blue-500 rounded-lg flex items-center justify-center">
            <span class="text-white font-bold text-lg">A</span>
        </div>
        <span class="ml-3 text-white font-semibold text-xl">Autopilot</span>
    </div>

    <!-- Namespace Dropdown -->
    <div class="px-4 mb-4">
        <div class="relative">
            <label class="block text-xs font-medium text-gray-400 mb-1">Namespace</label>
            <button @click="namespaceDropdownOpen = !namespaceDropdownOpen" 
                    class="w-full flex items-center justify-between px-3 py-2 text-sm font-medium text-white bg-slate-700 rounded-lg hover:bg-slate-600 transition-colors">
                <span x-text="selectedNamespace || 'Select namespace'"></span>
                <i class="ti ti-chevron-down text-base text-gray-400 transition-transform" :class="{ 'rotate-180': namespaceDropdownOpen }"></i>
            </button>
            
            <!-- Dropdown Menu -->
            <div x-show="namespaceDropdownOpen" @click.away="namespaceDropdownOpen = false" 
                 x-transition:enter="transition ease-out duration-100"
                 x-transition:enter-start="transform opacity-0 scale-95"
                 x-transition:enter-end="transform opacity-100 scale-100"
                 x-transition:leave="transition ease-in duration-75"
                 x-transition:leave-start="transform opacity-100 scale-100"
                 x-transition:leave-end="transform opacity-0 scale-95"
                 class="absolute z-50 w-full mt-1 bg-slate-700 rounded-lg shadow-lg ring-1 ring-black ring-opacity-5 max-h-48 overflow-y-auto">
                <div class="py-1">
                    <template x-for="namespace in namespaces" :key="namespace.id">
                        <button @click="selectNamespace(namespace)" 
                                class="w-full text-left px-3 py-2 text-sm text-white hover:bg-slate-600 transition-colors"
                                :class="{ 'bg-slate-600': namespace.name === selectedNamespace }"
                                x-text="namespace.name">
                        </button>
                    </template>
                    <div x-show="namespaces.length === 0" class="px-3 py-2 text-sm text-gray-400">
                        No namespaces available
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation -->
    <nav class="flex-1 px-4 space-y-1">
        <a :href="`/view/${selectedNamespace}/flows`" :class="isActiveLink('flows') ? 'flex items-center px-4 py-3 text-sm font-medium bg-blue-600 text-white rounded-lg transition-colors' : 'flex items-center px-4 py-3 text-sm font-medium text-gray-300 hover:bg-slate-700 hover:text-white rounded-lg transition-colors'">
            <i class="ti ti-grid-dots text-xl mr-3 flex-shrink-0"></i>
            Flows
        </a>
        <a :href="`/view/${selectedNamespace}/nodes`" :class="isActiveLink('nodes') ? 'flex items-center px-4 py-3 text-sm font-medium bg-blue-600 text-white rounded-lg transition-colors' : 'flex items-center px-4 py-3 text-sm font-medium text-gray-300 hover:bg-slate-700 hover:text-white rounded-lg transition-colors'">
            <i class="ti ti-server text-xl mr-3 flex-shrink-0"></i>
            Nodes
        </a>
        <a :href="`/view/${selectedNamespace}/credentials`" :class="isActiveLink('credentials') ? 'flex items-center px-4 py-3 text-sm font-medium bg-blue-600 text-white rounded-lg transition-colors' : 'flex items-center px-4 py-3 text-sm font-medium text-gray-300 hover:bg-slate-700 hover:text-white rounded-lg transition-colors'">
            <i class="ti ti-key text-xl mr-3 flex-shrink-0"></i>
            Credentials
        </a>
        <a :href="`/view/${selectedNamespace}/members`" :class="isActiveLink('members') ? 'flex items-center px-4 py-3 text-sm font-medium bg-blue-600 text-white rounded-lg transition-colors' : 'flex items-center px-4 py-3 text-sm font-medium text-gray-300 hover:bg-slate-700 hover:text-white rounded-lg transition-colors'">
            <i class="ti ti-users text-xl mr-3 flex-shrink-0"></i>
            Members
        </a>
        <a :href="`/view/${selectedNamespace}/approvals`" :class="isActiveLink('approvals') ? 'flex items-center px-4 py-3 text-sm font-medium bg-blue-600 text-white rounded-lg transition-colors' : 'flex items-center px-4 py-3 text-sm font-medium text-gray-300 hover:bg-slate-700 hover:text-white rounded-lg transition-colors'">
            <i class="ti ti-circle-check text-xl mr-3 flex-shrink-0"></i>
            Approvals
        </a>
        <a :href="`/view/${selectedNamespace}/history`" :class="isActiveLink('history') ? 'flex items-center px-4 py-3 text-sm font-medium bg-blue-600 text-white rounded-lg transition-colors' : 'flex items-center px-4 py-3 text-sm font-medium text-gray-300 hover:bg-slate-700 hover:text-white rounded-lg transition-colors'">
            <i class="ti ti-clock text-xl mr-3 flex-shrink-0"></i>
            History
        </a>
        <!-- Settings (only show for superusers) -->
        <a x-show="userProfile && userProfile.role === 'superuser'" href="/admin/settings" :class="isActiveLink('settings') ? 'flex items-center px-4 py-3 text-sm font-medium bg-blue-600 text-white rounded-lg transition-colors' : 'flex items-center px-4 py-3 text-sm font-medium text-gray-300 hover:bg-slate-700 hover:text-white rounded-lg transition-colors'">
            <i class="ti ti-settings text-xl mr-3 flex-shrink-0"></i>
            Settings
        </a>
    </nav>
</div>

<script>
function sidebarManager() {
    return {
        namespaceDropdownOpen: false,
        namespaces: [],
        selectedNamespace: '{{ .Page.Namespace }}',
        userProfile: null,
        
        init() {
            this.fetchNamespaces();
            this.fetchUserProfile();
        },
        
        isActiveLink(section) {
            const currentPath = window.location.pathname;
            
            // Handle namespace-specific routes
            if (section === 'flows') {
                return currentPath.includes('/flows') || currentPath.match(/^\/view\/[^\/]+\/?$/);
            } else if (section === 'nodes') {
                return currentPath.includes('/nodes');
            } else if (section === 'credentials') {
                return currentPath.includes('/credentials');
            } else if (section === 'members') {
                return currentPath.includes('/members');
            } else if (section === 'approvals') {
                return currentPath.includes('/approvals');
            } else if (section === 'history') {
                return currentPath.includes('/history');
            } else if (section === 'settings') {
                return currentPath.includes('/admin/settings');
            }
            
            return false;
        },
        
        async fetchNamespaces() {
            try {
                const response = await fetch('/api/v1/namespaces?count=100');
                const data = await response.json();
                this.namespaces = data.namespaces || [];
            } catch (error) {
                console.error('Failed to fetch namespaces:', error);
                this.notifyError('Failed to fetch namespaces');
                this.namespaces = [];
            }
        },
        
        async fetchUserProfile() {
            try {
                const response = await fetch('/api/v1/users/profile');
                const data = await response.json();
                this.userProfile = data;
            } catch (error) {
                console.error('Failed to fetch user profile:', error);
                this.notifyError('Failed to fetch user profile');
                this.userProfile = null;
            }
        },
        
        selectNamespace(namespace) {
            this.selectedNamespace = namespace.name;
            this.namespaceDropdownOpen = false;
            
            // Redirect to namespace view
            window.location.href = `/view/${namespace.name}`;
        },
        
        notifyError(message) {
            window.dispatchEvent(
                new CustomEvent("notify", {
                    detail: { message, type: "error" },
                })
            );
        }
    };
}
</script>
{{ end }}